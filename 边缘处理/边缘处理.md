# æ·±åº¦å‰–æå›¾åƒå¤„ç†â€”è¾¹ç¼˜æ£€æµ‹

## ä»€ä¹ˆæ˜¯è¾¹ç¼˜æ£€æµ‹

> **è¾¹ç¼˜æ£€æµ‹(Edge Detection)å°±æ˜¯æå–å›¾åƒä¸­çš„è¾¹ç¼˜ç‚¹(Edge Point)**ã€‚è¾¹ç¼˜ç‚¹æ˜¯ä¸å‘¨å›´åƒç´ ç›¸æ¯”ç°åº¦å€¼æœ‰é˜¶è·ƒå˜åŒ–æˆ–å±‹é¡¶çŠ¶å˜åŒ–çš„åƒç´ ã€‚è¾¹ç¼˜å¸¸å­˜åœ¨äºç›®æ ‡ä¸èƒŒæ™¯ä¹‹é—´ã€ç›®æ ‡ä¸ç›®æ ‡ä¹‹é—´ã€ç›®æ ‡ä¸å…¶å½±å­ä¹‹é—´ã€‚
>
> â€‹    åœ¨å›¾åƒå¤„ç†å’Œå›¾åƒåˆ†æä¸­ï¼Œç»å¸¸è¦ç”¨åˆ°**è¾¹ç¼˜(Edge)ã€è¾¹ç•Œ(Boundary)ã€è½®å»“(Contour)**ç­‰æœ¯è¯­ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¾¹ç¼˜æŒ‡çš„æ˜¯è¾¹ç¼˜ç‚¹ï¼Œå®ƒä¸èƒ½è¢«ç§°ä¸ºè¾¹ç¼˜çº¿ã€‚è¾¹ç•ŒæŒ‡çš„æ˜¯å›¾åƒä¸­ä¸åŒåŒºåŸŸä¹‹é—´çš„åˆ†ç•Œçº¿ï¼Œæ¯”å¦‚ä¸åŒç°åº¦ã€ä¸åŒé¢œè‰²çš„åŒºåŸŸä¹‹é—´çš„åˆ†ç•Œçº¿ï¼Œå®ƒæ˜¯çº¿è€Œä¸æ˜¯ç‚¹ï¼Œå¯ä»¥è¢«ç§°ä¸º**è¾¹ç•Œçº¿ã€‚è½®å»“ä¸€èˆ¬æ˜¯æŒ‡ç›®æ ‡çš„è½®å»“**ï¼Œç›®æ ‡å°±æ˜¯è¯­ä¹‰æ˜ç¡®çš„åŒºåŸŸï¼Œè½®å»“ä¸€èˆ¬æ˜¯åœ¨äºŒå€¼å›¾åƒä¸­å›´ç»•ç™½è‰²åŒºåŸŸçš„**é—­åˆæ›²çº¿**ã€‚
>
> â€‹    **è¾¹ç¼˜æ£€æµ‹ç®—æ³•å’Œè¾¹ç•Œçº¿æ£€æµ‹ç®—æ³•ä¸€èˆ¬ä½œç”¨äºç°åº¦å›¾åƒ**ï¼Œå¯¹äºäºŒå€¼å›¾åƒè¿›è¡Œè¾¹ç¼˜æ£€æµ‹æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚**è½®å»“ä¸€å®šæ˜¯é—­åˆçš„ï¼Œä½†è¾¹ç•Œçº¿ä¸ä¸€å®šé—­åˆ**ï¼Œæ¯”å¦‚é“è·¯åŒºåŸŸä¸é“è¾¹æ¤è¢«çš„è¾¹ç•Œçº¿ï¼›è¾¹ç¼˜ç‚¹æœ€å¤šæ˜¯æ–­æ–­ç»­ç»­çš„çº¿æ®µï¼Œä¸ä¿è¯è¿ç»­ï¼Œæ›´ä¸ä¿è¯é—­åˆã€‚æŒæ¡è¾¹ç¼˜ã€è¾¹ç•Œã€è½®å»“çš„å‡†ç¡®æœ¯è¯­æ˜¯éå¸¸å¿…è¦çš„ã€‚

## **è¾¹ç¼˜ç±»å‹**

è¾¹ç¼˜æ£€æµ‹æ˜¯ä¸€ç§é‚»åŸŸè¿ç®—ï¼Œå³ä¸€ä¸ªåƒç´ æ˜¯å¦æ˜¯è¾¹ç¼˜ç‚¹æ˜¯ç”±å…¶æ‰€å¤„çš„é‚»åŸŸå†³å®šçš„ã€‚åœ¨ä¸€å®šå¤§å°çš„é‚»åŸŸå†…ï¼Œè¾¹ç¼˜åˆ†ä¸ºé˜¶è·ƒè¾¹ç¼˜(step edge)å’Œå±‹é¡¶çŠ¶è¾¹ç¼˜(roof edge)ä¸¤ç§ç±»å‹ã€‚ä¸‹é¢ä»¥ä¸€ç»´ä¿¡å·ä¸ºä¾‹ï¼Œåˆ†æè¿™ä¸¤ç§ä¸åŒç±»å‹çš„è¾¹ç¼˜çš„å¯¼æ•°ç‰¹å¾

![image-20240421200943004](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404212009130.png)

### æ±‚å¯¼ä¸å·®åˆ†

åœ¨è¾¹ç¼˜æ£€æµ‹ä¸­ï¼Œå¯¼æ•°çš„è®¡ç®—é€šå¸¸é‡‡ç”¨ä¸¤ç§æ–¹æ³•ï¼š

* å°†é‚»åŸŸä»ç¦»æ•£ç©ºé—´å˜æ¢åˆ°è¿ç»­ç©ºé—´ï¼Œå¾—åˆ°è§£ææè¿°ï¼Œç„¶åè¿›è¡Œæ±‚å¯¼æ“ä½œ**ã€‚**

  >  å…·ä½“åšæ³•æ˜¯ï¼Œå…ˆå°†**é‚»åŸŸæŒ‰ç…§ä¸€å®šçš„æ•°å­¦æ¨¡å‹(æ›²çº¿æ‹Ÿåˆã€æ›²é¢æ‹Ÿåˆ)**å¾—åˆ°å…¶åœ¨è¿ç»­ç©ºé—´ä¸­çš„è§£ææè¿°ï¼Œç„¶åå¯¹æ­¤è§£ææè¿°è¿›è¡Œæ±‚å¯¼ï¼Œå¾—åˆ°è¾¹ç¼˜ç‚¹ã€‚è§£ææè¿°æ±‚å¯¼å¾—åˆ°çš„å¯¼æ•°ä½ç½®æ˜¯æœ‰å°æ•°ä½çš„ï¼Œæ¯”å¦‚åœ¨ä½ç½®4.17å¤„å–å¾—å¯¼æ•°æœ€å¤§å€¼ï¼Œå³è¾¹ç¼˜ç‚¹çš„ä½ç½®æ˜¯åœ¨4.17è€Œä¸æ˜¯åƒç´ çš„æ•´æ•°åæ ‡4ã€‚è¿™æ ·å¾—åˆ°çš„è¾¹ç¼˜ç‚¹ä½ç½®ç²¾åº¦èƒ½å¤Ÿå°äº1ä¸ªåƒç´ ï¼Œå› æ­¤åˆå°†æ­¤æ–¹æ³•ç§°ä¹‹ä¸ºäºšåƒç´ (sub pixel)è¾¹ç¼˜æ£€æµ‹**ã€‚**åœ¨å·²çŸ¥æ•°å­¦æ¨¡å‹çš„æŒ‡å¯¼ä¸‹ï¼Œç›®å‰å·¥ä¸šç•Œåšåˆ°çš„è¾¹ç¼˜æ£€æµ‹æœ€é«˜ç²¾åº¦ä¸º1/50ä¸ªåƒç´ **ã€‚**äºšåƒç´ è¾¹ç¼˜æ£€æµ‹èƒ½å¤Ÿåœ¨å¤§å¤§èŠ‚çœç¡¬ä»¶æˆæœ¬çš„åŒæ—¶ï¼Œå¾—åˆ°é«˜çš„è¾¹ç¼˜æ£€æµ‹ç²¾åº¦ï¼Œæ˜¯å›¾åƒæµ‹é‡ä¸­çš„å¸¸ç”¨æ–¹æ³•ã€‚

* ç›´æ¥ç”¨å·®åˆ†(difference)ä»£æ›¿æ±‚å¯¼ã€‚å¯¼æ•°çš„å…¬å¼è§ä¸‹å¼ï¼Œå¦‚æœä»¤dx=1ï¼Œå³å¾—åˆ°æ˜¯å·®åˆ†æè¿°ï¼Œå¼ï¼ˆ4-2ï¼‰æ˜¯å·®åˆ†æè¿°çš„xæ–¹å‘åå¯¼æ•°ï¼Œå¼(4-3)æ˜¯å·®åˆ†æè¿°çš„yæ–¹å‘åå¯¼æ•°ã€‚

![image-20240421202909028](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404212029058.png)

![image-20240421203632870](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404212036915.png)

## è¾¹ç¼˜å¼ºåº¦ä¸è¾¹ç¼˜æ–¹å‘

å¯¼æ•°æ˜¯æœ‰å¤§å°ä¹Ÿæœ‰æ–¹å‘çš„ï¼Œå› æ­¤è¾¹ç¼˜ä¹Ÿæœ‰å¼ºå¼±ä¸æ–¹å‘ï¼Œåˆ†åˆ«å«åšè¾¹ç¼˜å¼ºåº¦(edge intensity)å’Œè¾¹ç¼˜æ–¹å‘(edge direction)ï¼Œè¾¹ç¼˜å¼ºåº¦å³è¾¹ç¼˜çš„å¹…å€¼(magnitude)ã€‚ç”¨M(x,y)ä»£è¡¨è¾¹ç¼˜çš„å¼ºåº¦ï¼ŒÎ¸(x,y)ä»£è¡¨è¾¹ç¼˜çš„æ–¹å‘ï¼Œæœ‰ï¼š

![image-20240421204859267](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404212048299.png)

## å®ä¾‹

æˆ‘ä»¬è¯¥å¦‚ä½•æå–è¿™å¼ å›¾ç‰‡çš„è¾¹ç¼˜å‘¢?

![test](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221739974.bmp)

é¦–å…ˆå½“ç„¶æ˜¯éœ€è¦æˆ‘ä»¬å†™ä¸€ä¸ªå‡½æ•°æ¥æŠŠ24ä½å½©è‰²å›¾åƒè½¬åŒ–ä¸º8ä½ç°åº¦å€¼å›¾åƒ

```c
//24ä½å½©è‰²å›¾åƒè½¬8ä½ç°åº¦å€¼
//rgbImageåŸå§‹å›¾åƒ
//grayImageè¾“å‡ºç°åº¦å›¾åƒ
//width,heightå›¾ç‰‡çš„å®½å’Œé«˜
void convertToGray(uint8_t* rgbImage, uint8_t* grayImage, int width, int height)
{
    for (int y = 0; y < height; y++) {
        for (int x = 0; x < width; x++) {
            // è·å–å½“å‰åƒç´ çš„ RGB åˆ†é‡
            uint8_t r = rgbImage[3 * (y * width + x) + 0];
            uint8_t g = rgbImage[3 * (y * width + x) + 1];
            uint8_t b = rgbImage[3 * (y * width + x) + 2];

            // è®¡ç®—ç°åº¦å€¼ï¼ˆå¸¸ç”¨çš„åŠ æƒå¹³å‡æ³•ï¼‰
            // è¿™é‡Œä½¿ç”¨çš„åŠ æƒç³»æ•°æ˜¯å¸¸è§çš„ï¼šR: 0.299, G: 0.587, B: 0.114
            uint8_t gray = (uint8_t)(0.299 * r + 0.587 * g + 0.114 * b);

            // å°†ç°åº¦å€¼å†™å…¥ç°åº¦å›¾åƒæ•°ç»„
            grayImage[y * width + x] = gray;
        }
    }
}
```

æˆ‘ä»¬æ¥çœ‹çœ‹æ•ˆæœ

![image-20240422174937601](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221749822.png)

é‚£æ¥ä¸‹æ¥å°±éœ€è¦ç”¨è¾¹ç¼˜æ£€æµ‹æ¥æå–è¾¹ç¼˜äº†

# ä¸€é˜¶å¾®åˆ†ç®—å­

> æ ¹æ®è¾¹ç¼˜ç±»å‹åŠå…¶å¯¼æ•°ç‰¹å¾ï¼Œå¯ä»¥è®¾è®¡ä¸åŒçš„æ£€æµ‹ç®—æ³•ã€‚ä¸‹é¢è®²è¿°å‡ ç§å¸¸ç”¨çš„è¾¹ç¼˜æ£€æµ‹ç®—æ³•ï¼Œä¹ æƒ¯ä¸Šç§°ä¸º**è¾¹ç¼˜æ£€æµ‹ç®—å­(Operator)**ã€‚å½“ä½¿ç”¨å·®åˆ†æ—¶ï¼Œä¸€èˆ¬å†™æˆæ¨¡æ¿çš„è¡¨ç¤ºå½¢å¼ã€‚
>
>   å¯¹äºé˜¶è·ƒè¾¹ç¼˜è€Œè¨€ï¼Œè¾¹ç¼˜ç‚¹å¤„çš„å¯¼æ•°ç‰¹å¾æ˜¯â€œ**ä¸€é˜¶å¯¼æ•°å–æå€¼**â€ã€‚è‹¥è¾¹ç¼˜ç‚¹å¤„çš„ä¸€é˜¶å¯¼æ•°ä¸ºæ­£å€¼ï¼Œåˆ™å…¶ä¸ºæœ€å¤§å€¼ï¼›åä¹‹ï¼Œåˆ™ä¸ºæœ€å°å€¼ï¼Œå³åœ¨è¾¹ç¼˜ç‚¹å¤„çš„å¯¼æ•°ç»å¯¹å€¼æœ€å¤§ã€‚
>
>   åŸºäºä¸€é˜¶å¯¼æ•°çš„è¾¹ç¼˜æ£€æµ‹ç®—å­ç§°ä¸ºä¸€é˜¶å¾®åˆ†ç®—å­ï¼Œå¸¸ç”¨çš„ä¸€é˜¶å¾®åˆ†ç®—å­æœ‰**æ¢¯åº¦ç®—å­ã€ç½—ä¼¯ç‰¹ç®—å­ã€ç´¢è´å°”ç®—å­ã€Prewittç®—å­ï¼ŒRobinsonç®—å­ã€Kirschç®—å­**ç­‰ã€‚

## **æ¢¯åº¦ç®—å­**

æ¢¯åº¦çš„æœ¬æ„æ˜¯ä¸€ä¸ªå‘é‡ï¼ˆçŸ¢é‡ï¼‰ï¼Œè¡¨ç¤ºæŸä¸€å‡½æ•°åœ¨è¯¥ç‚¹å¤„çš„æ–¹å‘å¯¼æ•°æ²¿ç€è¯¥æ–¹å‘å–å¾—æœ€å¤§å€¼ï¼Œå³**å‡½æ•°åœ¨è¯¥ç‚¹å¤„æ²¿ç€è¯¥æ–¹å‘ï¼ˆæ­¤æ¢¯åº¦çš„æ–¹å‘ï¼‰å˜åŒ–æœ€å¿«ï¼Œå˜åŒ–ç‡æœ€å¤§ï¼ˆä¸ºè¯¥æ¢¯åº¦çš„æ¨¡ï¼‰**ã€‚æ¢¯åº¦çš„å«ä¹‰å’Œè¾¹ç¼˜ç‚¹æ˜¯ä¸€è‡´çš„ï¼Œå› æ­¤äº§ç”Ÿäº†è¾¹ç¼˜æ£€æµ‹çš„**æ¢¯åº¦ç®—å­(Gradient Operator)**

![image-20240422172912964](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221729999.png)



å†™æˆæ¨¡æ¿çš„æƒ…å†µå°±æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20240422172958535](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221729563.png)

ä½†æ˜¯ä¸Šé¢æˆ‘ä»¬åªæ˜¯ç»™å‡ºäº†åƒç´ (x,y)çš„è¾¹ç¼˜å¼ºåº¦ï¼Œç§°ä¸ºæ¢¯åº¦å€¼ï¼›ä½†æ˜¯å®ƒæ˜¯ä¸æ˜¯è¾¹ç¼˜ç‚¹ï¼Œè¿˜éœ€è¦ä¸€å®šçš„çº¦æŸæ¡ä»¶ï¼Œæ¯”å¦‚ï¼Œè®¾å®šå½“Gradient(x,y)â‰¥thresholdæ—¶ï¼Œåƒç´ (x,y)æ‰æ˜¯è¾¹ç¼˜ç‚¹ï¼Œthresholdç§°ä¸ºé˜ˆå€¼ã€‚    

![image-20240422173629195](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221736223.png)

è¿™å°±æ˜¯ç”¨æ¢¯åº¦ç®—å­è®¡ç®—çš„ç»“æœï¼Œæˆ‘ä»¬ä¸Šä»£ç çœ‹çœ‹

```c
void RmwGradientGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pGrdImg)
{
    uint8_t* pGry, * pGrd;
    int dx, dy;
    int x, y;

    for (y = 0, pGry = pGryImg, pGrd = pGrdImg; y < height - 1; y++)
    {
        for (x = 0; x < width - 1; x++, pGry++)
        {
            dx = *pGry - *(pGry + 1);
            dy = *pGry - *(pGry + width);
            int gradient = (int)(sqrt(dx * dx * 1.0 + dy * dy));
            *pGrd++ = (gradient > 255) ? 255 : gradient;
        }
        *pGrd++ = 0; //å°¾åˆ—ä¸åš,è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pGrd, 0, width); //å°¾è¡Œä¸åš,è¾¹ç¼˜å¼ºåº¦èµ‹0
}
```

è¿™é‡Œç®€å•è¯´ä¸€ä¸‹è¿™ä¸ªå‡½æ•°

> 1. å‡½æ•°å‚æ•°ï¼š
>    - `pGryImg`ï¼šè¾“å…¥çš„ç°åº¦å›¾åƒæ•°æ®æŒ‡é’ˆã€‚
>    - `width`ï¼šå›¾åƒçš„å®½åº¦ã€‚
>    - `height`ï¼šå›¾åƒçš„é«˜åº¦ã€‚
>    - `pGrdImg`ï¼šè¾“å‡ºçš„æ¢¯åº¦å›¾åƒæ•°æ®æŒ‡é’ˆã€‚
> 2. åŒå±‚å¾ªç¯ï¼š
>    - å¤–å±‚å¾ªç¯ `for (y = 0, pGry = pGryImg, pGrd = pGrdImg; y<height-1; y++)` éå†å›¾åƒçš„æ¯ä¸€è¡Œï¼Œ`pGry` å’Œ `pGrd` åˆ†åˆ«æŒ‡å‘å½“å‰è¡Œçš„ç°åº¦å›¾åƒæ•°æ®å’Œæ¢¯åº¦å›¾åƒæ•°æ®ã€‚
>    - å†…å±‚å¾ªç¯ `for (x = 0; x<width-1; x++, pGry++)` éå†å½“å‰è¡Œçš„æ¯ä¸ªåƒç´ ï¼Œ`pGry` æŒ‡å‘å½“å‰åƒç´ çš„ç°åº¦å€¼ã€‚
> 3. è®¡ç®—æ¢¯åº¦ï¼š
>    - æ¢¯åº¦çš„è®¡ç®—é‡‡ç”¨çš„æ˜¯ç®€å•çš„åŸºäºåƒç´ å·®å€¼çš„æ–¹æ³•ï¼Œåˆ†åˆ«è®¡ç®—æ°´å¹³æ–¹å‘å’Œå‚ç›´æ–¹å‘çš„æ¢¯åº¦ã€‚
>    - `dx = *pGry-*(pGry+1)`ï¼šæ°´å¹³æ–¹å‘çš„æ¢¯åº¦ï¼Œè®¡ç®—å½“å‰åƒç´ å’Œå³ä¾§åƒç´ çš„ç°åº¦å·®å€¼ã€‚
>    - `dy = *pGry-*(pGry+width)`ï¼šå‚ç›´æ–¹å‘çš„æ¢¯åº¦ï¼Œè®¡ç®—å½“å‰åƒç´ å’Œä¸‹æ–¹åƒç´ çš„ç°åº¦å·®å€¼ã€‚
>    - `sqrt(dx*dx*1.0+dy*dy)`ï¼šä½¿ç”¨æ¬§å¼è·ç¦»å…¬å¼è®¡ç®—æ¢¯åº¦å¹…å€¼ã€‚
>    - `min(255, ...)`ï¼šç¡®ä¿æ¢¯åº¦å¹…å€¼ä¸è¶…è¿‡255ï¼Œé™å®šåœ¨0åˆ°255ä¹‹é—´ã€‚
> 4. å†…å­˜æ¸…é›¶ï¼š
>    - `memset(pGrd, 0, width)`ï¼šæ¸…é›¶è¾“å‡ºå›¾åƒçš„æœ€åä¸€è¡Œï¼Œå› ä¸ºæœ€åä¸€è¡Œçš„æ¢¯åº¦å€¼æœªè®¡ç®—ã€‚
> 5. è¿”å›ï¼š
>    - å‡½æ•°è¿”å›ï¼Œå¤„ç†å®Œæˆã€‚

çœ‹çœ‹å®é™…è¿è¡Œçš„æ•ˆæœæ˜¯ä»€ä¹ˆæ ·å­çš„

![image-20240422180246550](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221802684.png)

æ•ˆæœå¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œæˆ‘ä»¬æŠŠåŸå§‹å›¾åƒåšä¸€ä¸‹å›¾åƒå¢å¼ºï¼ˆç°åº¦å€¼å‡è¡¡åŒ–ï¼‰è¯•è¯•

![image-20240422181123926](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221811116.png)

æ¢ä¸€ç§å›¾åƒå¢å¼ºçš„æ–¹æ³•ï¼ŒåŠ ä¸€ä¸‹åç›¸è¯•è¯•

å…ˆç®€å•å†™ä¸€ä¸‹åç›¸çš„å‡½æ•°

```c
void invertImage(uint8_t *image, int width, int height) {
    for (int i = 0; i < width * height; i++) {
        image[i] = 255 - image[i];
    }
}
```

è¿™æ¬¡ä½¿ç”¨äº†çº¿æ€§æ‹‰ä¼¸å¹¶ç®€å•å¤„ç†äº†ä¸€ä¸‹å‚æ•°

![image-20240422181718341](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221817509.png)

æ•ˆæœè¿˜ç®—ä¸é”™ï¼Œé‚£å¦‚æœåŠ ä¸€ä¸‹é˜ˆå€¼å‘¢ï¼Ÿå°±åƒä¸Šé¢è¯´çš„ï¼Œæˆ‘ä»¬é‡æ–°å†™ä¸€ä¸‹è¿™ä¸ªå‡½æ•°

```c
//æ¢¯åº¦ç®—å­åŠ é˜ˆå€¼
//pGryImgï¼šè¾“å…¥çš„ç°åº¦å›¾åƒæ•°æ®æŒ‡é’ˆã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
//pGrdImgï¼šè¾“å‡ºçš„æ¢¯åº¦å›¾åƒæ•°æ®æŒ‡é’ˆ
void RmwGradientGryImgPlus(uint8_t* pGryImg, int width, int height, uint8_t* pGrdImg, int threshold)
{
    uint8_t* pGry, * pGrd;
    int dx, dy;
    int x, y;

    for (y = 0, pGry = pGryImg, pGrd = pGrdImg; y < height - 1; y++)
    {
        for (x = 0; x < width - 1; x++, pGry++)
        {
            dx = *pGry - *(pGry + 1);
            dy = *pGry - *(pGry + width);
            int gradient = (int)(sqrt(dx * dx * 1.0 + dy * dy));
            *(pGrd++) = (gradient > threshold) ? min(255, gradient) : 0;
        }
        *(pGrd++) = 0; //å°¾åˆ—ä¸åš,è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pGrd, 0, width); //å°¾è¡Œä¸åš,è¾¹ç¼˜å¼ºåº¦èµ‹0
}
```

çœ‹ä¸€ä¸‹æ•ˆæœ

![image-20240422182112492](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221821533.png)

ç”»é¢ç¡®å®å˜å¾—æ›´å¹²å‡€äº†

---

## **ç½—ä¼¯ç‰¹ç®—å­**

**æ¢¯åº¦ç®—å­çš„è®¡ç®—åªæ¶‰åŠåˆ°äº†3ä¸ªåƒç´ ï¼Œåªåœ¨æ°´å¹³å’Œå‚ç›´æ–¹å‘åšå·®åˆ†**ã€‚**ç½—ä¼¯ç‰¹ç®—å­ï¼ˆRoberts Operator)ç»™å‡ºäº†ä¸€ä¸ª4ä¸ªåƒç´ ä¹‹é—´è¿›è¡Œè¿ç®—çš„ç®—å­ï¼Œåˆ†åˆ«åœ¨ä¸¤ä¸ªå¯¹è§’çº¿æ–¹å‘åšå·®åˆ†**ã€‚

![image-20240422182433397](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221824424.png)

â€‹    ç”±äº**å¯¹è§’çº¿ä¸Š2ä¸ªåƒç´ ä¹‹é—´çš„è·ç¦»ä¸ºâˆš2**ï¼Œæ‰€ä»¥ç½—ä¼¯ç‰¹ç®—å­çš„âˆ†xå’Œâˆ†yé‡‡ç”¨å¯¹è§’çº¿å·®åˆ†åï¼Œä¸å†é‡‡ç”¨âˆš(âˆ†_x^2+âˆ†_y^2 )ï¼Œå…¶æè¿°è§ä¸‹å¼ã€‚**ç½—ä¼¯ç‰¹ç®—å­å–âˆ†xç»å¯¹å€¼ä¸âˆ†yç»å¯¹å€¼ä¸­çš„æœ€å¤§å€¼ã€‚**

![image-20240422182518316](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221825349.png)

æˆ‘ä»¬æ¥çœ‹æ¼”ç¤º

![image-20240422182547389](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221825422.png)

é‚£ä¹ˆç½—ä¼¯ç‰¹ç®—å­å¥½åœ¨å“ªå‘¢ï¼Ÿ

**ç½—ä¼¯ç‰¹ç®—å­å»æ‰äº†æ¢¯åº¦ç®—å­çš„å¼€æ–¹è¿ç®—ï¼Œè®¡ç®—å¤æ‚åº¦ä¹Ÿé™ä½äº†ä¸å°‘ã€‚**

```c
void RmwRobertsGryImg(uint8_t *pGryImg, int width, int height, uint8_t *pRbtImg)
{
    uint8_t *pGry, *pRbt;
    int dx, dy;
    int x, y;

    for (y = 0, pGry = pGryImg, pRbt = pRbtImg; y < height - 1; y++)
    {
        for (x = 0; x < width - 1; x++, pGry++)
        {
            dx = *pGry - *(pGry + width + 1);
            dy = *(pGry + 1) - *(pGry + width);
            *pRbt++ = (uint8_t)(dx > dy ? dx : dy); // ä½¿ç”¨ä¸‰ç›®è¿ç®—ç¬¦é€‰æ‹©è¾ƒå¤§çš„å€¼
        }
        *pRbt++ = 0; // å°¾åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pRbt, 0, width); // å°¾è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
}
```

æˆ‘ä»¬æ¥çœ‹ç»“æœ

![image-20240422192132132](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221921280.png)

ä¸ºä»€ä¹ˆçœ‹èµ·æ¥çš„æ•ˆæœå¥½åƒè¿˜æ²¡æœ‰æ¢¯åº¦ç®—å­çš„ç»“æœå¥½å‘¢

æ˜¯å› ä¸ºå›¾åƒå¤ªå¤æ‚æ²¡æœ‰æ»¤æ³¢ï¼Œé‚£ä¹ˆåœ¨è¾¹ç¼˜è®¡ç®—å‰èƒ½ä¸èƒ½å…ˆæ»¤æ³¢ï¼Ÿ

æˆ‘ä»¬æ¥çœ‹ä¸‹ä¸€ä¸ªç®—å­

## **ç´¢è´å°”ç®—å­**

åœ¨ä¸€å¹…å™ªå£°è¾ƒå¤§çš„å›¾åƒä¸­ï¼Œå¦‚æœä¸è¿›è¡Œå›¾åƒå¹³æ»‘å°±è¿›è¡Œè¾¹ç¼˜æ£€æµ‹ï¼Œ**å¿…ç„¶ä¼šåœ¨è¾¹ç¼˜å›¾åƒä¸­äº§ç”Ÿå™ªå£°å¹²æ‰°**ã€‚

  å› æ­¤ï¼Œ**ç´¢è´å°”ç®—å­(Sobel Operator)ä¸­ï¼Œåœ¨æ±‚âˆ†xå’Œâˆ†yå‰ï¼Œå…ˆè¿›è¡Œæ»¤æ³¢**ã€‚åœ¨æ±‚âˆ†xå‰ï¼Œå…ˆæ‰§è¡Œå¦‚ä¸‹å›¾çš„æ‰€ç¤ºçš„é«˜æ–¯å‡å€¼æ»¤æ³¢ï¼›åœ¨æ±‚âˆ†yå‰ï¼Œå…ˆæ‰§è¡Œå¦‚ä¸‹å›¾çš„æ‰€ç¤ºçš„é«˜æ–¯å‡å€¼æ»¤æ³¢ã€‚

![image-20240422184902956](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221849989.png)

 å¦å¤–ï¼Œ**ç´¢è´å°”ç®—å­è¿›ä¸€æ­¥æ‹‰å¤§è¿›è¡Œå·®åˆ†çš„2ä¸ªåƒç´ ä¹‹é—´çš„è·ç¦»**ï¼Œâˆ†xå’Œâˆ†yé‡‡ç”¨å¦‚ä¸‹çš„æ¨¡æ¿å½¢å¼

![image-20240422184942115](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221849145.png)

æˆ‘ä»¬æ¥çœ‹ç¤ºæ„å›¾

![image-20240422185037120](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221850150.png)

åœ¨å›¾åƒ1ä¸­ï¼Œçº¢è‰²æ–¹å—ä»£è¡¨å½“å‰åƒç´ (x,y)ï¼Œå…ˆæ‰§è¡Œå›¾4-8(a)æ‰€ç¤ºçš„é«˜æ–¯æ»¤æ³¢ï¼Œç”¨D Ì…ã€E Ì…ä»£è¡¨æ»¤æ³¢åçš„å€¼ï¼Œåˆ™å¾—åˆ°ï¼š

![image-20240422185102632](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221851656.png)

æ‰§è¡Œâˆ†xæ¨¡æ¿ï¼Œåˆ™æœ‰âˆ†x=D Ì…-E Ì…=(A+2D+F)-(C+2E+H)

![image-20240422185448932](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221854965.png)

å¦å¤–ï¼Œ**ç´¢è´å°”ç®—å­åœ¨å¯¹âˆ†xå’Œâˆ†yçš„ä½¿ç”¨ä¸Šï¼Œé‡‡ç”¨äº†å®ƒä»¬çš„ç»å¯¹å€¼ç›¸åŠ çš„å½¢å¼**

![image-20240422185539273](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221855298.png)

çœ‹æ•ˆæœï¼š

![image-20240422185603424](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221856462.png)

å¯¹åŸå§‹ç°åº¦å›¾åƒæ‰§è¡Œç´¢è´å°”ç®—å­å¾—åˆ°çš„ç»“æœï¼Œå›¾ä¸­è™šçº¿æ¡†æ‰€ç¤ºçš„**è¾¹ç¼˜å˜æˆäº†åŒçº¿å®½**ã€‚

æˆ‘ä»¬æ¥å†™ä»£ç 

```c
//ç´¢è´å°”ç®—å­
void RmwSobelGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pSbImg)
{
    uint8_t* pGry, * pSb;
    int dx, dy;
    int x, y;

    memset(pSbImg, 0, width); // é¦–è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
    for (y = 1, pGry = pGryImg + width, pSb = pSbImg + width; y < height - 1; y++)
    {
        *pSb++ = 0; // é¦–åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
        for (x = 1; x < width - 1; x++, pGry++)
        {
            // æ±‚dx
            dx = *(pGry - 1 - width) + (*(pGry - 1) * 2) + *(pGry - 1 + width);
            dx -= *(pGry + 1 - width) + (*(pGry + 1) * 2) + *(pGry + 1 + width);
            // æ±‚dy
            dy = *(pGry - width - 1) + (*(pGry - width) * 2) + *(pGry - width + 1);
            dy -= *(pGry + width - 1) + (*(pGry + width) * 2) + *(pGry + width + 1);
            // ç»“æœ
            *pSb++ = (uint8_t)min(255, abs(dx) + abs(dy));
        }
        *pSb++ = 0; // å°¾åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pSb, 0, width); // å°¾è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
}
```

![image-20240422191511580](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221915735.png)



## **æ¢¯åº¦ç®—å­ã€ç½—ä¼¯ç‰¹ç®—å­ã€ç´¢è´å°”ç®—å­çš„æ¯”è¾ƒ**

ä»¥ä¸‹ä»4ä¸ªæ–¹é¢å¯¹æ¢¯åº¦ç®—å­ã€ç½—ä¼¯ç‰¹ç®—å­ã€ç´¢è´å°”ç®—å­è¿›è¡Œæ¯”è¾ƒã€‚

**â€¢1. åå¯¼æ•°âˆ†xå’Œâˆ†yçš„æ±‚å–**

   æ¢¯åº¦ç®—å­åœ¨3ä¸ªåƒç´ ä¹‹é—´è¿›è¡Œè¿ç®—ï¼Œåªåœ¨æ°´å¹³å’Œå‚ç›´æ–¹å‘åšå·®åˆ†ï¼Œåšå·®åˆ†çš„2ä¸ªåƒç´ ä¹‹é—´çš„è·ç¦»ä¸º1ã€‚

  ç½—ä¼¯ç‰¹ç®—å­åœ¨4ä¸ªåƒç´ ä¹‹é—´è¿›è¡Œè¿ç®—ï¼Œåˆ†åˆ«åœ¨ä¸¤ä¸ªå¯¹è§’çº¿æ–¹å‘åšå·®åˆ†ï¼Œåšå·®åˆ†çš„2ä¸ªåƒç´ ä¹‹é—´çš„è·ç¦»ä¸ºâˆš2ã€‚

  ç´¢è´å°”ç®—å­åœ¨8ä¸ªåƒç´ ä¹‹é—´è¿›è¡Œè¿ç®—ï¼Œåªåœ¨æ°´å¹³å’Œå‚ç›´æ–¹å‘åšå·®åˆ†ï¼Œåšå·®åˆ†çš„2ä¸ªåƒç´ ä¹‹é—´çš„è·ç¦»ä¸º2ã€‚

**â€¢2. æ˜¯å¦â€œå…ˆå¹³æ»‘åæ±‚å¯¼â€**

  ç´¢è´å°”ç®—å­åœ¨å·®åˆ†ä¹‹å‰ï¼Œè¿›è¡Œäº†åŠ æƒå‡å€¼æ»¤æ³¢å¯¹å›¾åƒè¿›è¡Œå¹³æ»‘ï¼ˆåŠ æƒå‡½æ•°é‡‡ç”¨äº†é«˜æ–¯å‡½æ•°ï¼‰ï¼Œå› æ­¤ç´¢è´å°”å…·æœ‰æ»¤é™¤å™ªå£°çš„æ•ˆæœã€‚æ¢¯åº¦ç®—å­å’Œç½—ä¼¯ç‰¹ç®—å­éƒ½æ²¡æœ‰è¿›è¡Œå¹³æ»‘ã€‚â€œå…ˆå¹³æ»‘åæ±‚å¯¼â€æ˜¯è¾¹ç¼˜æ£€æµ‹çš„é€šç”¨ç­–ç•¥ï¼Œä¸€èˆ¬åœ¨æ‰§è¡Œæ¢¯åº¦ç®—å­å’Œç½—ä¼¯ç‰¹ç®—å­å‰æ˜¯éœ€è¦ä½¿ç”¨å¦å¤–çš„æ­¥éª¤åšå›¾åƒå¹³æ»‘ï¼Œç´¢è´å°”ç®—å­åˆ™æ˜¯æŠŠå¹³æ»‘å†™åˆ°äº†ç®—å­ä¸­ã€‚

**â€¢3. è¾¹ç¼˜å¼ºåº¦çš„å¤§å°**

  æŒ‰ç…§å¼(4-4)è¾¹ç¼˜å¼ºåº¦çš„å®šä¹‰ï¼Œæ¢¯åº¦ç®—å­æ˜¯ä¸¥æ ¼éµå®ˆçš„ï¼Œç½—ä¼¯ç‰¹ç®—å­æ˜¯å–âˆ†xç»å¯¹å€¼å’Œâˆ†yç»å¯¹å€¼ä¸­çš„æœ€å¤§å€¼ï¼Œç´¢è´å°”ç®—å­æ˜¯å–âˆ†xä¸âˆ†yçš„ç»å¯¹å€¼ä¹‹å’Œã€‚è€Œä¸”ï¼Œç´¢è´å°”ç®—å­åœ¨é«˜æ–¯æ»¤æ³¢åæ²¡æœ‰é™¤ä»¥4ï¼Œæ‰€ä»¥åˆç›¸å½“äºâˆ†xã€âˆ†yæ”¾å¤§äº†4å€ã€‚å¯¹äºè¾¹ç¼˜å¼ºåº¦ï¼Œç½—ä¼¯ç‰¹ç®—å­ã€æ¢¯åº¦ç®—å­ã€ç´¢è´å°”ç®—å­ä¹‹é—´çš„æ•°å€¼å…³ç³»å¤§è‡´å¦‚ä¸‹ï¼š

![image-20240422195609623](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221956661.png)

**â€¢4. é‚»åŸŸä¸è¾¹ç¼˜å®½åº¦**

  æ¢¯åº¦ç®—å­ã€ç½—ä¼¯ç‰¹ç®—å­çš„è®¡ç®—åªæ¶‰åŠåˆ°äº†2è¡Œ2åˆ—ï¼Œæ‰€ä»¥å®ƒä»¬å¾—åˆ°çš„è¾¹ç¼˜å®½åº¦æ˜¯1ä¸ªåƒç´ ï¼›ç´¢è´å°”ç®—å­æ¶‰åŠåˆ°äº†3è¡Œ3åˆ—ï¼Œæ‰€ä»¥å®ƒå¾—åˆ°çš„è¾¹ç¼˜å®½åº¦æ˜¯2ä¸ªåƒç´ ï¼Œè¾¹ç¼˜å˜æˆäº†åŒçº¿å®½ã€‚

# **æ–¹å‘æ¨¡æ¿**

>   è‹¥æ˜¯èƒ½æ ¹æ®è¾¹ç¼˜çš„å…·ä½“èµ°å‘æ±‚åå¯¼æ•°ï¼Œåˆ™è¾¹ç¼˜å¼ºåº¦å€¼åº”è¯¥ä¼šæ›´å‡†ç¡®ã€‚
>
>   å› æ­¤åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ˜¯å…ˆå‡å®šäº†æœ‰é™çš„å‡ ä¸ªè¾¹ç¼˜æ–¹å‘ï¼Œå†å¯¹è¿™äº›å‡å®šçš„æ¯ä¸ªè¾¹ç¼˜æ–¹å‘è®¾ç½®ä¸€ä¸ªç‰¹å®šçš„æ¨¡æ¿ï¼Œè®¡ç®—æ¯ä¸ªæ¨¡æ¿çš„è¾¹ç¼˜å¼ºåº¦ï¼Œä»ä¸­é€‰æ‹©æœ€å¤§çš„è¾¹ç¼˜å¼ºåº¦ä½œä¸ºè¾¹ç¼˜å¼ºåº¦çš„ç»“æœï¼Œè€Œä¸”è¯¥æœ€å¤§è¾¹ç¼˜å¼ºåº¦å¯¹åº”æ¨¡æ¿çš„æ–¹å‘å°±è®¤ä¸ºæ˜¯è¾¹ç¼˜çš„æ–¹å‘ã€‚
>
>   å¸¸ç”¨åŸºäºæ–¹å‘æ¨¡æ¿çš„è¾¹ç¼˜æ£€æµ‹ç®—å­æœ‰ï¼šPrewittç®—å­ï¼ŒRobinsonç®—å­ã€Kirschç®—å­ã€‚Prewittç®—å­ä½¿ç”¨4ä¸ªæ–¹å‘æ¨¡æ¿ï¼ŒRobinsonç®—å­å’ŒKirschç®—å­éƒ½ä½¿ç”¨8ä¸ªæ–¹å‘æ¨¡æ¿ã€‚è¿™äº›ç®—å­éƒ½æ˜¯å…ˆé‡‡ç”¨äº†å‡å€¼æ»¤æ³¢ï¼Œç„¶åè¿›è¡Œå·®åˆ†è®¡ç®—ã€‚

## **Prewitt**ç®—å­

  Prewittç®—å­è®¾å®šäº†0Â°ã€45Â°ã€90Â°å’Œ135Â°ï¼Œå…±è®¡4ç§è¾¹ç¼˜æ–¹å‘ï¼›æ ¹æ®è¿™4ç§è¾¹ç¼˜æ–¹å‘ï¼Œåˆ†åˆ«è®¾è®¡äº†4ä¸ªæ¨¡æ¿

![image-20240422195755759](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404221957790.png)

**å¯¹æ¯ä¸ªåƒç´ åˆ†åˆ«è®¡ç®—è¿™ä¸ª4ä¸ªæ¨¡æ¿çš„å€¼ï¼Œå–ç»å¯¹å€¼æœ€å¤§è€…ä½œä¸ºè¯¥åƒç´ çš„è¾¹ç¼˜å¼ºåº¦Prewitt(x,y)ã€‚åŒæ—¶è¯¥æœ€å¤§å€¼å¯¹åº”æ¨¡æ¿çš„æ–¹å‘ä½œä¸ºè¯¥åƒç´ çš„è¾¹ç¼˜æ–¹å‘**(ä¸è¾¹ç¼˜çš„èµ°å‘ç›¸å·®90Â°ï¼Œå› ä¸ºæ˜¾ç„¶è¾¹ç¼˜èµ°å‘çš„æ³•çº¿æ–¹å‘ä¸Šçš„å¯¼æ•°æœ€å¤§)ã€‚è‹¥æŠŠè¿™äº›æ¨¡æ¿ä¸­ä¸ºâ€œ0â€ç‚¹(ç©ºç™½å¤„)çš„è¿æˆä¸€æ¡ç›´çº¿ï¼Œå¯ä»¥å‘ç°è¿™äº›æ¨¡æ¿å¼ºè°ƒäº†æ°´å¹³çº¿ã€135Â°æ–œçº¿ã€ç«–ç›´çº¿ã€45Â°æ–œçº¿çš„æ£€æµ‹ã€‚**Prewittç®—å­å¼ºè°ƒå¯¹ç›´çº¿çš„æ£€æµ‹ï¼Œå¯¹äºä¸Šè¿°èµ°å‘çš„ç›´çº¿ï¼Œæ€»æœ‰ä¸€ä¸ªæ¨¡æ¿çš„è¾“å‡ºå€¼æœ€å¤§**ã€‚

```c
void RmwPrewittGryImg(uint8_t *pGryImg, int width, int height, uint8_t *pPRTImg)
{
    uint8_t *pGry, *pPRT;
    int dx, dy, d45, d135, v1, v2;
    int x, y;

    memset(pPRTImg, 0, width); // é¦–è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
    for (y = 1, pGry = pGryImg + width, pPRT = pPRTImg + width; y < height - 1; y++)
    {
        *pPRT++ = 0; // é¦–åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
        for (x = 1; x < width - 1; x++, pGry++)
        {
            // æ±‚dx
            dx = *(pGry - 1 - width) + *(pGry - 1) + *(pGry - 1 + width);
            dx -= *(pGry + 1 - width) + *(pGry + 1) + *(pGry + 1 + width);
            // æ±‚dy
            dy = *(pGry - width - 1) + *(pGry - width) + *(pGry - width + 1);
            dy -= *(pGry + width - 1) + *(pGry + width) + *(pGry + width + 1);
            // æ±‚45åº¦
            d45 = *(pGry - width - 1) + *(pGry - width) + *(pGry - 1);
            d45 -= *(pGry + width + 1) + *(pGry + width) + *(pGry + 1);
            // æ±‚135åº¦
            d135 = *(pGry - width) + *(pGry - width + 1) + *(pGry + 1);
            d135 -= *(pGry + width - 1) + *(pGry + width) + *(pGry - 1);
            // ç»“æœ
            v1 = abs(dx) > abs(dy) ? abs(dx) : abs(dy);
            v2 = abs(d45) > abs(d135) ? abs(d45) : abs(d135);
            *pPRT++ = (uint8_t)((v1 > v2) ? ((v1 > 255) ? 255 : v1) : ((v2 > 255) ? 255 : v2));
        }
        *pPRT++ = 0; // å°¾åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pPRT, 0, width); // å°¾è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
}
```

æˆ‘ä»¬çœ‹ä¸€ä¸‹å®ç°æ•ˆæœ

![image-20240422200701865](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404222007025.png)

## Robinsonç®—å­

**Robinsonç®—å­**é™¤(a)å¤–çš„7ä¸ªæ¨¡æ¿ï¼Œéƒ½æ˜¯ç”±å…¶ä¸Šä¸ªæ¨¡æ¿é¡ºæ—¶é’ˆæ—‹è½¬1ä¸ªåƒç´ å¾—åˆ°çš„ã€‚è‹¥æ˜¯æŠŠæ¨¡æ¿ä¸­çš„è´Ÿæ•°å€¼åˆå¹¶æˆä¸€ä¸ªåŒºåŸŸï¼Œå¯ä»¥çœ‹å‡ºè¯¥ç®—å­**å¼ºè°ƒäº†å¯¹è§’ç‚¹çš„æ£€æµ‹ï¼›å¯¹äºå„ç§å½¢çŠ¶çš„è§’ç‚¹ï¼Œæ€»æœ‰ä¸€ä¸ªæ¨¡æ¿çš„è¾“å‡ºå€¼æœ€å¤§ã€‚**

![image-20240422200914550](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404222009592.png)

æœ‰å…´è¶£å¤§å®¶å¯ä»¥æŸ¥ä¸€ä¸‹å•Šï¼Œè¿™é‡Œå°±ä¸å†è¿‡å¤šè§£é‡Š

# äºŒé˜¶å¾®åˆ†ç®—å­

ä¸€é˜¶å¾®åˆ†ç®—å­èƒ½å¤Ÿå¾—åˆ°è¾¹ç¼˜å¼ºåº¦ï¼Œä½†æ˜¯éœ€è¦å†åŠ ä¸Šä¸€å®šçš„æ¡ä»¶çº¦æŸï¼Œæ¯”å¦‚è®¾ç½®ä¸ªé˜ˆå€¼ï¼Œæ‰èƒ½åˆ¤å®šä¸€ä¸ªåƒç´ æ˜¯ä¸æ˜¯è¾¹ç¼˜ç‚¹ã€‚

é€šè¿‡å¯¹è¾¹ç¼˜ç±»å‹åŠå…¶å¯¼æ•°çš„åˆ†æå¯çŸ¥ï¼Œ**é˜¶è·ƒè¾¹ç¼˜çš„å¯¼æ•°ç‰¹å¾é™¤äº†â€œä¸€é˜¶å¯¼æ•°å–æå€¼â€å¤–ï¼Œè¿˜æœ‰â€œäºŒé˜¶å¯¼æ•°è¿‡é›¶ç‚¹â€ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨äºŒé˜¶å¯¼æ•°ï¼Œåˆ©ç”¨è¿‡é›¶ç‚¹å¾—åˆ°è¾¹ç¼˜ç‚¹ï¼Œè¿™æ ·å°±ä¸éœ€è¦å…¶ä»–çš„æ¡ä»¶äº†ã€‚**

## æ‹‰æ™®æ‹‰æ–¯ç®—å­

  æ‹‰æ™®æ‹‰æ–¯ç®—å­(Laplacian Operator)æ˜¯è¿‘ä¼¼ç»™å‡ºäºŒé˜¶å¯¼æ•°çš„æµè¡Œæ–¹æ³•ï¼Œå…¶ä½¿ç”¨3Ã—3çš„é‚»åŸŸï¼Œç»™å‡ºäº†4-é‚»æ¥å’Œ8-é‚»æ¥çš„é‚»åŸŸçš„2ç§æ¨¡æ¿

![image-20240422201917270](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404222019305.png)

å¯¹å¦‚å›¾æ‰€ç¤ºçš„åŸå§‹ç°åº¦å›¾åƒæ‰§è¡Œ4é‚»åŸŸæ‹‰æ™®æ‹‰æ–¯ç®—å­ï¼Œå¾—åˆ°çš„ç»“æœå¦‚å›¾æ‰€ç¤ºï¼Œå›¾ä¸­è™šçº¿æ¡†æ‰€ç¤ºçš„ä½ç½®ä¸Šå‘ç”Ÿäº†è¿‡é›¶ç‚¹ï¼ˆå¯¼æ•°ç”±è´Ÿæ•°å˜åˆ°äº†æ­£æ•°ï¼‰ï¼Œæ­¤å¤„å³è¾¹ç¼˜ã€‚

![image-20240422202053683](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404222020718.png)

â€‹    åœ¨æ‹‰æ™®æ‹‰æ–¯ç®—å­çš„ç»“æœå›¾åƒä¸­ï¼Œå¯ä»¥å‘ç°è¿‡é›¶ç‚¹ä½ç½®åˆšå¥½å°±æ˜¯è¾¹ç¼˜çš„ä½ç½®ã€‚ç”±äºè¿‡é›¶ç‚¹æ˜¯åœ¨åƒç´ ä¹‹é—´ï¼Œä¸åœ¨æ•´æ•°åæ ‡ä¸Šï¼Œæ‰€ä»¥åœ¨æå–è¾¹ç¼˜ç‚¹æ—¶ï¼Œå¾€å¾€é‡‡å–ä¸‹é¢çš„ç­–ç•¥ï¼š

**å½“ä¸€ä¸ªåƒç´ çš„äºŒé˜¶å¯¼æ•°å¤§äº0ï¼Œå…¶é‚»åŸŸå†…æœ‰åƒç´ çš„äºŒé˜¶å¯¼æ•°å°äº0æˆ–ç­‰äº0ï¼Œåˆ™è¯¥åƒç´ è¢«æ ‡è®°ä¸ºè¾¹ç¼˜ç‚¹ã€‚**

## æ²ˆä¿Šç®—å­

å”¯ä¸€ä¸€ä¸ªä»¥å›½äººå‘½åçš„ç®—å­

> æ²ˆä¿Šæ•™æˆåŒæ ·æå‡ºäº†**å…ˆæ»¤æ³¢åæ±‚å¯¼çš„è¾¹ç¼˜æ£€æµ‹æ–¹æ³•**ï¼ˆJ. Shen and S. Castan, An optimal linear operator for step edge detection, CVGIP: Graphical Models and Image Processing, Vol. 54 No.2, Mar. 1992, pp.112 â€“ 133ï¼‰ï¼Œå³æ²ˆä¿Šç®—å­(ShenJun Edge Operator)ã€‚

æ²ˆæ•™æˆåœ¨é˜¶è·ƒè¾¹ç¼˜å’Œå¯åŠ ç™½å™ªå£°æ¨¡å‹ä¸‹ï¼Œå°±ä¿¡å™ªæ¯”æœ€å¤§å‡†åˆ™ï¼Œè¯æ˜äº†å›¾åƒå¹³æ»‘çš„æœ€ä½³æ»¤æ³¢å™¨æ˜¯å¯¹ç§°çš„æŒ‡æ•°å‡½æ•°ï¼Œå½¢å¼å¦‚ä¸‹ï¼š

![image-20240422202508333](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404222025366.png)

æ˜¾ç„¶ï¼Œ**å½“a_0è¶Šå¤§æ—¶ï¼Œc2å°±è¶Šå°ï¼ŒT(j,i)å°±è¶Šé™¡è¶Šçª„ï¼Œç›¸å½“äºæ»¤æ³¢é‚»åŸŸå°±è¶Šå°ï¼Œå‹åˆ¶å™ªå£°çš„èƒ½åŠ›å°±å¼±ï¼Œå›¾åƒæ¨¡ç³Šç¨‹åº¦å°±è¶Šå°ï¼Œè¾¹ç¼˜å®šä½çš„ç²¾åº¦å°±è¶Šé«˜ã€‚**

åœ¨ç®—å­å®ç°ä¸Šï¼Œæ²ˆæ•™æˆå¯¹**å›¾åƒåˆ†åˆ«æŒ‰è¡Œã€æŒ‰åˆ—å„è¿›è¡Œä¸¤æ¬¡å…ˆæ­£æ–¹å‘å†åæ–¹å‘çš„é€’æ¨æ»¤æ³¢**å®ç°(|j|ã€|i|çš„ä¼˜ç‚¹)ï¼Œç­‰ä»·äºç”¨ä¸Šè¿°æŒ‡æ•°å‡½æ•°è¿›è¡Œå›¾åƒæ»¤æ³¢ï¼›è¯æ˜äº†**æ»¤æ³¢ç»“æœå‡å»åŸå§‹ç°åº¦å€¼å¾—åˆ°çš„å·®å€¼ä¹˜**ä»¥2c1ã€–lnã€—^c2ï¼Œçº¦ç­‰äºå…¶äºŒé˜¶å¯¼æ•°çš„å€¼ã€‚æ²ˆä¿Šç®—å­çš„å®ç°è¿‡ç¨‹å¦‚ä¸‹ï¼š

```c
æ²ˆä¿Šç®—å­çš„å®ç°è¿‡ç¨‹
step.1 å¯¹æ¯è¡Œä»å·¦å‘å³è¿›è¡Œï¼š
ğ‘”1(0,ğ‘¦)=ğ‘”(0,ğ‘¦)ï¼Œ
ğ‘”1(ğ‘¥,ğ‘¦)=ğ‘”1(ğ‘¥âˆ’1,ğ‘¦)+ğ‘_0Ã—(ğ‘”(ğ‘¥,ğ‘¦)âˆ’ğ‘”1(ğ‘¥âˆ’1,ğ‘¦))ï¼Œğ‘¥=1,2,â‹¯ğ‘¤ğ‘–ğ‘‘ğ‘¡â„âˆ’1ã€‚
step.2 å¯¹æ¯è¡Œä»å³å‘å·¦è¿›è¡Œï¼š
ğ‘”2(ğ‘¤ğ‘–ğ‘‘ğ‘¡â„âˆ’1,ğ‘¦)=ğ‘”1(ğ‘¤ğ‘–ğ‘‘ğ‘¡â„âˆ’1,ğ‘¦)ï¼Œ
ğ‘”2(ğ‘¥,ğ‘¦)=ğ‘”2(ğ‘¥+1,ğ‘¦)+ğ‘_0Ã—(ğ‘”1(ğ‘¥,ğ‘¦)âˆ’ğ‘”2(ğ‘¥+1,ğ‘¦))ï¼Œğ‘¥=ğ‘¤ğ‘–ğ‘‘ğ‘¡â„âˆ’2, â‹¯, 1,0ã€‚
step.3 å¯¹æ¯åˆ—ä»ä¸Šå‘ä¸‹è¿›è¡Œï¼š
ğ‘”3(ğ‘¥,0)=ğ‘”2(ğ‘¥,0)ï¼Œ
ğ‘”3(ğ‘¥,ğ‘¦)=ğ‘”3(ğ‘¥,ğ‘¦âˆ’1)+ğ‘_0Ã—(ğ‘”2(ğ‘¥,ğ‘¦)âˆ’ğ‘”3(ğ‘¥,ğ‘¦âˆ’1))ï¼Œğ‘¦=1,2,â‹¯â„ğ‘’ğ‘–ğ‘”â„ğ‘¡âˆ’1ã€‚
step.4 å¯¹æ¯åˆ—ä»ä¸‹å‘ä¸Šè¿›è¡Œï¼š
ğ‘”4(ğ‘¥,â„ğ‘–ğ‘”â„ğ‘¡âˆ’1)=ğ‘”3(ğ‘¥,â„ğ‘–ğ‘”â„ğ‘¡âˆ’1)ï¼Œ
ğ‘”4(ğ‘¥,ğ‘¦)=ğ‘”4(ğ‘¥,ğ‘¦+1)+ğ‘_0Ã—(ğ‘”3(ğ‘¥,ğ‘¦)âˆ’ğ‘”4(ğ‘¥,ğ‘¦+1))ï¼Œğ‘¦=â„ğ‘’ğ‘–ğ‘”â„ğ‘¡âˆ’2, â‹¯, 1,0ã€‚
step.5 å¯¹æ¯ä¸ªåƒç´ (ğ‘¥,ğ‘¦)æ‰§è¡Œğ‘†ğ½(ğ‘¥,ğ‘¦)=ğ‘”4(ğ‘¥,ğ‘¦)âˆ’ğ‘”(ğ‘¥,ğ‘¦)ï¼Œå¾—åˆ°äºŒé˜¶å¯¼æ•°ğ‘†ğ½(ğ‘¥,ğ‘¦)ã€‚
step.6 å¯¹æ¯ä¸ªåƒç´ ğ‘†ğ½(ğ‘¥,ğ‘¦)è¿›è¡Œè¿‡é›¶ç‚¹æ£€æµ‹å¾—åˆ°è¾¹ç¼˜ç‚¹ã€‚
```

æˆ‘ä»¬æ¥çœ‹ç¨‹åº

```c
//æ²ˆä¿Šç®—å­
//pGryImg å’Œ pTmpImg æ˜¯æŒ‡å‘ uint8_t ç±»å‹çš„æŒ‡é’ˆï¼Œå®ƒä»¬åˆ†åˆ«æŒ‡å‘åŸå§‹ç°åº¦å›¾åƒæ•°æ®å’Œè¾…åŠ©å›¾åƒæ•°æ®ã€‚
//width å’Œ height æ˜¯æ•´å‹å‚æ•°ï¼Œè¡¨ç¤ºå›¾åƒçš„å®½åº¦å’Œé«˜åº¦ã€‚
//a0 æ˜¯åŒç²¾åº¦æµ®ç‚¹å‹å‚æ•°ï¼Œè¡¨ç¤ºæ»¤æ³¢ç³»æ•°ã€‚
//pSJImg æ˜¯æŒ‡å‘ uint8_t ç±»å‹çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘äº†è¾“å‡ºçš„å›¾åƒæ•°æ®ã€‚
void RmwShenJunGryImg(uint8_t* pGryImg,uint8_t* pTmpImg, int width, int height, double a0, uint8_t* pSJImg)
{
    uint8_t* pGry, * pCur, * pSJ, * pEnd;
    int LUT[512], * ALUT; // a0æŸ¥æ‰¾è¡¨
    int x, y, pre, dif;

    // Step 1: åˆå§‹åŒ–æŸ¥æ‰¾è¡¨
    a0 = (a0 < 0.01) ? 0.01 : ((a0 > 0.99) ? 0.99 : a0); // å®‰å…¨æ€§æ£€æŸ¥
    // a0æŸ¥æ‰¾è¡¨, è¿›è¡Œäº†å››èˆäº”å…¥
    ALUT = LUT + 256;
    for (ALUT[0] = 0, dif = 1; dif < 256; dif++)
    {
        ALUT[dif] = (int)(dif * a0 + 0.5);
        ALUT[-dif] = (int)(-dif * a0 - 0.5);
    }

    // Step 2: é€’æ¨å®ç°æŒ‡æ•°æ»¤æ³¢
    // æŒ‰è¡Œæ»¤æ³¢
    for (y = 0, pGry = pGryImg, pCur = pTmpImg; y < height; y++)
    {
        // ä»å·¦å‘å³: p1(y,x) = p1(y,x-1) + a * [p(y,x) - p1(y,x-1)]
        *(pCur++) = pre = *(pGry++);
        for (x = 1; x < width; x++, pGry++)
            *(pCur++) = pre = pre + ALUT[*pGry - pre];
        pCur--; // å›åˆ°è¡Œå°¾
        // ä»å³å‘å·¦: p2(y,x) = p2(y,x+1) - a * [p1(y,x) - p2(y,x+1)]
        for (x = width - 2, pCur = pCur - 1; x >= 0; x--)
            *(pCur--) = pre = pre + ALUT[*pCur - pre];
        pCur += (width + 1); // å›åˆ°ä¸‹ä¸€è¡Œçš„å¼€å§‹
    }
    // æŒ‰åˆ—æ»¤æ³¢
    for (x = 0, pCur = pTmpImg; x < width; x++, pCur = pTmpImg + x)
    {
        // ä»ä¸Šå‘ä¸‹: p3(y,x) = p3(y-1,x) + a * [p2(y,x) - p3(y-1,x)]
        pre = *pCur;
        for (y = 1, pCur += width; y < height; y++, pCur += width)
            *pCur = pre = pre + ALUT[*pCur - pre];
        pCur -= width; // å›åˆ°åˆ—å°¾
        // ä»ä¸‹å‘ä¸Š: p4(i,j) = p4(i+1,j) + a * [p3(i,j) - p4(i+1,j)]
        for (y = height - 2, pCur -= width; y >= 0; y--, pCur -= width)
            *pCur = pre = pre + ALUT[*pCur - pre];
    }

    // Step 3: æ­£å¯¼æ•°=1ï¼Œè´Ÿå¯¼æ•°ä¸º0ï¼Œ0å¿…é¡»ä¹Ÿæ˜¯0
    pEnd = pTmpImg + width * height;
    for (pCur = pTmpImg, pGry = pGryImg; pCur < pEnd; pGry++)
    {
        *(pCur++) = (*pCur > *pGry);
    }

    // Step 4: è¿‡é›¶ç‚¹æ£€æµ‹
    memset(pSJImg, 0, width * height); // è¾¹ç¼˜å¼ºåº¦èµ‹0
    pSJ = pSJImg + width;
    pCur = pTmpImg + width; // é¦–è¡Œä¸åš 
    for (y = 1; y < height - 1; y++)
    {
        pSJ++; pCur++;  // é¦–åˆ—ä¸åš
        for (x = 1; x < width - 1; x++, pGry++, pCur++, pSJ++)
        {
            if (*pCur) // æ­£å¯¼æ•°
            {
                // ä¸‹é¢ä½¿ç”¨4é‚»åŸŸ, è¾¹ç¼˜ä¸º8è¿é€š, ä¸èƒ½ä¿è¯4è¿é€š; ä½¿ç”¨8é‚»åŸŸæ‰èƒ½ä¿è¯è¾¹ç¼˜4è¿é€š
                if ((!*(pCur - 1)) || // å·¦, å¿…é¡»<=0, ä¸èƒ½<0
                    (!*(pCur + 1)) || // å³, å¿…é¡»<=0, ä¸èƒ½<0
                    (!*(pCur - width)) || // ä¸Š, å¿…é¡»<=0, ä¸èƒ½<0
                    (!*(pCur + width)))   // ä¸‹, å¿…é¡»<=0, ä¸èƒ½<0
                {
                    *pSJ = 255; // å‘¨å›´æœ‰å¯¼æ•°å°äºç­‰äº0
                }
            }
        }
        pSJ++; pCur++;  // å°¾åˆ—ä¸åš
    }
}
```

å½“æ»¤æ³¢ç³»æ•°ä¸º0.1æ—¶ï¼Œæˆ‘ä»¬æ¥çœ‹æ•ˆæœ

![image-20240422204121096](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404222041230.png)



> æ²ˆä¿Šç®—å­èƒ½å¤Ÿå¾—åˆ°é—­åˆçš„è¾¹ç¼˜ã€‚ä¸€ç§è¾¹ç¼˜æ£€æµ‹æ–¹æ³•èƒ½å¤Ÿå¾—åˆ°ä¸€èˆ¬è¦ç”¨å›¾åƒåˆ†å‰²æ‰èƒ½å¾—åˆ°çš„ç›®æ ‡è½®å»“ï¼Œä¼šå…·æœ‰å¾ˆé«˜çš„å®ç”¨ä»·å€¼ã€‚ 
>
> æ²ˆä¿Šç®—å­åªéœ€è¦ä¸€ä¸ªå‚æ•°a_0ï¼Œä¸”a_0è¯­ä¹‰æ˜ç¡®ï¼Œè€Œä¸”æ²ˆä¿Šç®—å­çš„ä»£ç é‡éå¸¸å°ï¼Œæ‰€ä»¥æ²ˆä¿Šç®—å­ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚

# æµ‹è¯•

é‚£ä¹ˆè¯¥å¦‚ä½•æ›´å¥½çš„å¾—åˆ°æˆ‘ä»¬åŸå§‹å›¾åƒçš„è¾¹ç¼˜å‘¢

å¯èƒ½ä¸€ä¸ªè¾¹ç¼˜å¤„ç†éƒ½æ²¡æœ‰åŠæ³•å¾—åˆ°å¾ˆå¥½çš„æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆå¤šä¸ªå¤„ç†åŠæ³•

![image-20240422204713809](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404222047188.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•ˆæœæ¯”è¾ƒå¥½çš„æ˜¯ç´¢è´å°”ç®—å­ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç»“åˆä¸€ä¸‹

```c
//æ²ˆä¿Šç®—å­åŠ ç´¢è´å°”ç®—å­
//pGryImgï¼šæŒ‡å‘åŸå§‹ç°åº¦å›¾åƒæ•°æ®çš„æŒ‡é’ˆ
//pTmpImgï¼šæŒ‡å‘è¾…åŠ©å›¾åƒæ•°æ®çš„æŒ‡é’ˆ
//widthï¼šå›¾åƒçš„å®½åº¦
//heightï¼šå›¾åƒçš„é«˜åº¦
//a0ï¼šè¿™æ˜¯æ²ˆä¿Šç®—å­çš„å‚æ•°ï¼Œç”¨äºæ§åˆ¶è¾¹ç¼˜æ£€æµ‹çš„çµæ•åº¦ã€‚
//grdThreï¼šè¿™æ˜¯Sobelç®—å­çš„æ¢¯åº¦é˜ˆå€¼
//pEdgeImgï¼šæœ€ç»ˆè¾¹ç¼˜å›¾åƒæ•°æ®çš„æŒ‡é’ˆ
void RmwExtractRiceEdge(uint8_t* pGryImg,uint8_t* pTmpImg,int width,int height,double a0, int grdThre, uint8_t* pEdgeImg)
{
    // step.1------------æ²ˆä¿Šç®—å­-----------------------//
    RmwShenJunGryImg(pGryImg, pTmpImg, width, height, a0, pEdgeImg);
    // step.2------------Sobelç®—å­----------------------//
    RmwSobelGryImg(pGryImg, width, height, pTmpImg);
    // step.3------------äºŒè€…èåˆ-----------------------//
    for (int i = 0; i < width * height; i++)
    {
        *(pEdgeImg + i) = (pEdgeImg[i] && (pTmpImg[i] > grdThre)) * 255;
    }
    // step.4------------ç»“æŸ---------------------------//
    return;
}
```

![image-20240422211324490](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404222113637.png)

æˆ‘ä»¬æ¢ä¸€å¼ å›¾ç‰‡è¯•ä¸€ä¸‹

![image-20240422212038348](https://gitee.com/jason_pei/typora-bed/raw/master/image/202404222120412.png)

# æ€»ç»“

é‚£ä¹ˆåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æˆåŠŸçš„è¿›è¡Œè¾¹ç¼˜æ£€æµ‹

æ¥ä¸‹æ¥å°±æ˜¯è¾¹ç¼˜å¢å¼ºï¼Œè¾¹ç¼˜åˆ†å‰²ç­‰ç›¸å…³å†…å®¹ï¼Œä¼šå°½å¿«æ›´æ–°



# æºç 

## IDP.h

```c
#pragma once

#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <math.h>
#include <nmmintrin.h>
 
uint8_t* readGrayScaleBMP(const char* filename, int* width, int* height);//è¯»å–8ä½ç°åº¦å›¾ç‰‡
void saveGrayScaleBMP(const char* filename, const uint8_t* imageData, int width, int height);// å°†8ä½ç°åº¦å›¾åƒæ•°æ®ä¿å­˜ä¸ºBMPæ–‡ä»¶
uint8_t* readColorBMP(const char* filename, int* width, int* height);//è¯»å–24ä½å½©è‰²å›¾åƒçš„BMPæ–‡ä»¶
void saveColorBMP(const char* filename, const uint8_t* imageData, int width, int height);//å°†24ä½å½©è‰²å›¾åƒæ•°æ®ä¿å­˜ä¸ºBMPæ–‡ä»¶
void convertToGray(uint8_t* rgbImage, uint8_t* grayImage, int width, int height);//24ä½å½©è‰²å›¾åƒè½¬8ä½ç°åº¦å€¼
void LinearStretchDemo(uint8_t* pGryImg, int width, int height, double k, double b);//ç°åº¦çº¿æ€§æ‹‰ä¼¸
void GetHistogram(uint8_t* pImg, int width, int height, int* histogram);//ç»Ÿè®¡å›¾åƒç°åº¦å€¼
void GetBrightContrast(int* histogram, double* bright, double* contrast);//äº®åº¦å’Œå¯¹æ¯”åº¦
void RmwHistogramEqualize(uint8_t* pGryImg, int width, int height);//ç›´æ–¹å›¾å‡è¡¡åŒ–
void RmwLogTransform(uint8_t* pGryImg, int width, int height);//å¯¹æ•°å˜æ¢
void RmwAvrFilterBySumCol(uint8_t* pGryImg, int width, int height, int M, int N, uint8_t* pResImg);//åŸºäºåˆ—ç§¯åˆ†çš„å¿«é€Ÿå‡å€¼æ»¤æ³¢
void RmwDoSumGryImg(uint8_t* pGryImg, int width, int height, int* pSumImg);//åŸºäºåˆ—ç§¯åˆ†çš„ç§¯åˆ†å›¾å®ç°
void RmwDoSumGryImg_SSE(uint8_t* pGryImg, int width, int height, int* pSumImg);//åŸºäºSSEçš„ç§¯åˆ†å›¾å®ç°
void RmwAvrFilterBySumImg(int* pSumImg, int width, int height, int M, int N, uint8_t* pResImg);//åŸºäºç§¯åˆ†å›¾çš„å¿«é€Ÿå‡å€¼æ»¤æ³¢  
void GetMedianGry(int* histogram, int N, int* medGry);//æ±‚ç°åº¦å€¼ä¸­å€¼
double RmwMedianFilter(uint8_t* pGryImg, int width, int height, int M, int N, uint8_t* pResImg);//ä¸­å€¼æ»¤æ³¢
void RmwBinImgFilter(uint8_t* pBinImg, int width, int height, int M, int N, double threshold, uint8_t* pResImg);//äºŒå€¼æ»¤æ³¢
void RmwGradientGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pGrdImg);//æ¢¯åº¦ç®—å­
void RmwGradientGryImgPlus(uint8_t* pGryImg, int width, int height, uint8_t* pGrdImg, int threshold);//æ¢¯åº¦ç®—å­åŠ é˜ˆå€¼
void invertImage(uint8_t* image, int width, int height);//åç›¸
void RmwRobertsGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pRbtImg);//ç½—ä¼¯ç‰¹ç®—å­
void RmwSobelGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pSbImg);//ç´¢è´å°”ç®—å­
void RmwPrewittGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pPRTImg); //Prewittç®—å­
void RmwShenJunGryImg(uint8_t* pGryImg, uint8_t* pTmpImg, int width, int height, double a0, uint8_t* pSJImg);//æ²ˆä¿Šç®—å­
void RmwExtractRiceEdge(uint8_t* pGryImg, uint8_t* pTmpImg, int width, int height, double a0, int grdThre, uint8_t* pEdgeImg);//ç´¢è´å°”ï¼‹æ²ˆä¿Šç®—å­
```

## IDP.c

```c
#define _CRT_SECURE_NO_WARNINGS 1

#include "IDP.h"

//è¯»å–8ä½ç°åº¦å›¾ç‰‡
//filenameï¼šå­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆï¼Œç”¨äºæŒ‡å®šè¦ä¿å­˜çš„å›¾åƒæ–‡ä»¶çš„åç§°æˆ–è·¯å¾„ã€‚
//imageDataï¼šæ— ç¬¦å· 8 ä½æ•´å‹æ•°æ®çš„æŒ‡é’ˆï¼Œä»£è¡¨è¦ä¿å­˜çš„å›¾åƒæ•°æ®ã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
uint8_t* readGrayScaleBMP(const char* filename, int* width, int* height) 
{
    FILE* file = fopen(filename, "rb");
    if (!file) {
        fprintf(stderr, "Error opening file %s\n", filename);
        return NULL;
    }

    // è¯»å–BMPæ–‡ä»¶å¤´éƒ¨ä¿¡æ¯
    uint8_t bmpHeader[54];
    fread(bmpHeader, 1, 54, file);

    // ä»æ–‡ä»¶å¤´éƒ¨æå–å›¾åƒå®½åº¦å’Œé«˜åº¦ä¿¡æ¯
    *width = *(int*)&bmpHeader[18];
    *height = *(int*)&bmpHeader[22];

    // åˆ†é…å­˜å‚¨å›¾åƒæ•°æ®çš„å†…å­˜
    uint8_t* imageData = (uint8_t*)malloc(*width * *height);
    if (!imageData) {
        fprintf(stderr, "å†…å­˜åˆ†é…å¤±è´¥\n");
        fclose(file);
        return NULL;
    }

    // è®¡ç®—è°ƒè‰²æ¿çš„å¤§å°
    int paletteSize = *(int*)&bmpHeader[46];
    if (paletteSize == 0)
        paletteSize = 256;

    // è¯»å–è°ƒè‰²æ¿æ•°æ®
    uint8_t palette[1024];
    fread(palette, 1, paletteSize * 4, file);

    // è¯»å–å›¾åƒæ•°æ®
    fseek(file, *(int*)&bmpHeader[10], SEEK_SET);
    fread(imageData, 1, *width * *height, file);

    fclose(file);

    return imageData;
}

// å°†8ä½ç°åº¦å›¾åƒæ•°æ®ä¿å­˜ä¸ºBMPæ–‡ä»¶
//filenameï¼šå­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆï¼Œç”¨äºæŒ‡å®šè¦ä¿å­˜çš„å›¾åƒæ–‡ä»¶çš„åç§°æˆ–è·¯å¾„ã€‚
//imageDataï¼šæ— ç¬¦å· 8 ä½æ•´å‹æ•°æ®çš„æŒ‡é’ˆï¼Œä»£è¡¨è¦ä¿å­˜çš„å›¾åƒæ•°æ®ã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
void saveGrayScaleBMP(const char* filename, const uint8_t* imageData, int width, int height) 
{
    FILE* file = fopen(filename, "wb");
    if (!file) {
        fprintf(stderr, "Error creating file %s\n", filename);
        return;
    }

    // BMPæ–‡ä»¶å¤´éƒ¨ä¿¡æ¯
    uint8_t bmpHeader[54] = {
        0x42, 0x4D,             // æ–‡ä»¶ç±»å‹æ ‡è¯† "BM"
        0x36, 0x00, 0x0C, 0x00, // æ–‡ä»¶å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œæ­¤å¤„å‡è®¾å›¾åƒæ•°æ®å¤§å°ä¸è¶…è¿‡4GBï¼‰
        0x00, 0x00,             // ä¿ç•™å­—æ®µ
        0x00, 0x00,             // ä¿ç•™å­—æ®µ
        0x36, 0x00, 0x00, 0x00, // ä½å›¾æ•°æ®åç§»ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰
        0x28, 0x00, 0x00, 0x00, // ä½å›¾ä¿¡æ¯å¤´å¤§å°ï¼ˆ40å­—èŠ‚ï¼‰
        0x00, 0x00, 0x00, 0x00, // å›¾åƒå®½åº¦
        0x00, 0x00, 0x00, 0x00, // å›¾åƒé«˜åº¦
        0x01, 0x00,             // ç›®æ ‡è®¾å¤‡çš„çº§åˆ«ï¼ˆæ­¤å¤„ä¸º1ï¼Œä¸å‹ç¼©ï¼‰
        0x08, 0x00,             // æ¯ä¸ªåƒç´ çš„ä½æ•°ï¼ˆ8ä½ï¼‰
        0x00, 0x00, 0x00, 0x00, // å‹ç¼©ç±»å‹ï¼ˆæ­¤å¤„ä¸ºä¸å‹ç¼©ï¼‰
        0x00, 0x00, 0x00, 0x00, // å›¾åƒæ•°æ®å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œæ­¤å¤„ä¸º0ï¼Œè¡¨ç¤ºä¸å‹ç¼©ï¼‰
        0x00, 0x00, 0x00, 0x00, // æ°´å¹³åˆ†è¾¨ç‡ï¼ˆåƒç´ /ç±³ï¼Œæ­¤å¤„ä¸º0ï¼Œè¡¨ç¤ºæœªçŸ¥ï¼‰
        0x00, 0x00, 0x00, 0x00, // å‚ç›´åˆ†è¾¨ç‡ï¼ˆåƒç´ /ç±³ï¼Œæ­¤å¤„ä¸º0ï¼Œè¡¨ç¤ºæœªçŸ¥ï¼‰
        0x00, 0x00, 0x00, 0x00, // ä½¿ç”¨çš„é¢œè‰²ç´¢å¼•æ•°ï¼ˆ0è¡¨ç¤ºä½¿ç”¨æ‰€æœ‰è°ƒè‰²æ¿é¡¹ï¼‰
        0x00, 0x00, 0x00, 0x00  // é‡è¦çš„é¢œè‰²ç´¢å¼•æ•°ï¼ˆ0è¡¨ç¤ºæ‰€æœ‰é¢œè‰²éƒ½é‡è¦ï¼‰
    };

    // æ›´æ–°BMPæ–‡ä»¶å¤´éƒ¨ä¿¡æ¯ä¸­çš„å®½åº¦å’Œé«˜åº¦
    *(int*)&bmpHeader[18] = width;
    *(int*)&bmpHeader[22] = height;

    // å†™å…¥BMPæ–‡ä»¶å¤´éƒ¨ä¿¡æ¯
    fwrite(bmpHeader, 1, 54, file);

    // å†™å…¥è°ƒè‰²æ¿æ•°æ®
    for (int i = 0; i < 256; i++) {
        fputc(i, file);  // è“è‰²åˆ†é‡
        fputc(i, file);  // ç»¿è‰²åˆ†é‡
        fputc(i, file);  // çº¢è‰²åˆ†é‡
        fputc(0, file);  // ä¿ç•™å­—èŠ‚
    }

    // å†™å…¥å›¾åƒæ•°æ®
    fwrite(imageData, 1, width * height, file);

    fclose(file);
}

// è¯»å–24ä½å½©è‰²å›¾åƒçš„BMPæ–‡ä»¶
//filenameï¼šå­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆï¼Œç”¨äºæŒ‡å®šè¦è¯»å–çš„ BMP æ ¼å¼å›¾åƒæ–‡ä»¶çš„åç§°æˆ–è·¯å¾„ã€‚
//widthï¼šæ•´å‹å˜é‡çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨è¯»å–çš„å›¾åƒçš„å®½åº¦ã€‚
//heightï¼šæ•´å‹å˜é‡çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨è¯»å–çš„å›¾åƒçš„é«˜åº¦ã€‚
uint8_t* readColorBMP(const char* filename, int* width, int* height) 
{
    FILE* file = fopen(filename, "rb");
    if (!file) {
        fprintf(stderr, "Error opening file %s\n", filename);
        return NULL;
    }

    // è¯»å–BMPæ–‡ä»¶å¤´éƒ¨ä¿¡æ¯
    uint8_t bmpHeader[54];
    fread(bmpHeader, 1, 54, file);

    // ä»æ–‡ä»¶å¤´éƒ¨æå–å›¾åƒå®½åº¦å’Œé«˜åº¦ä¿¡æ¯
    *width = *(int*)&bmpHeader[18];
    *height = *(int*)&bmpHeader[22];

    // åˆ†é…å­˜å‚¨å›¾åƒæ•°æ®çš„å†…å­˜
    uint8_t* imageData = (uint8_t*)malloc(*width * *height * 3);
    if (!imageData) {
        fprintf(stderr, "Memory allocation failed\n");
        fclose(file);
        return NULL;
    }

    // è¯»å–å›¾åƒæ•°æ®
    fseek(file, *(int*)&bmpHeader[10], SEEK_SET);
    fread(imageData, 1, *width * *height * 3, file);

    fclose(file);

    return imageData;
}

//å°†24ä½å½©è‰²å›¾åƒæ•°æ®ä¿å­˜ä¸ºBMPæ–‡ä»¶
//filenameï¼šå­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆï¼Œç”¨äºæŒ‡å®šè¦ä¿å­˜çš„å›¾åƒæ–‡ä»¶çš„åç§°æˆ–è·¯å¾„ã€‚
//imageDataï¼šæ— ç¬¦å· 8 ä½æ•´å‹æ•°æ®çš„æŒ‡é’ˆï¼Œä»£è¡¨è¦ä¿å­˜çš„å›¾åƒæ•°æ®ã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
void saveColorBMP(const char* filename, const uint8_t* imageData, int width, int height) 
{
    FILE* file = fopen(filename, "wb");
    if (!file) {
        fprintf(stderr, "Error creating file %s\n", filename);
        return;
    }

    // BMPæ–‡ä»¶å¤´éƒ¨ä¿¡æ¯
    uint8_t bmpHeader[54] = {
        0x42, 0x4D,             // æ–‡ä»¶ç±»å‹æ ‡è¯† "BM"
        0x00, 0x00, 0x00, 0x00, // æ–‡ä»¶å¤§å°ï¼ˆå ä½ï¼Œç¨åè®¡ç®—ï¼‰
        0x00, 0x00,             // ä¿ç•™å­—æ®µ
        0x00, 0x00,             // ä¿ç•™å­—æ®µ
        0x36, 0x00, 0x00, 0x00, // ä½å›¾æ•°æ®åç§»ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰
        0x28, 0x00, 0x00, 0x00, // ä½å›¾ä¿¡æ¯å¤´å¤§å°ï¼ˆ40å­—èŠ‚ï¼‰
        0x00, 0x00, 0x00, 0x00, // å›¾åƒå®½åº¦
        0x00, 0x00, 0x00, 0x00, // å›¾åƒé«˜åº¦
        0x01, 0x00,             // ç›®æ ‡è®¾å¤‡çš„çº§åˆ«ï¼ˆæ­¤å¤„ä¸º1ï¼Œä¸å‹ç¼©ï¼‰
        0x18, 0x00,             // æ¯ä¸ªåƒç´ çš„ä½æ•°ï¼ˆ24ä½ï¼‰
        0x00, 0x00, 0x00, 0x00, // å‹ç¼©ç±»å‹ï¼ˆæ­¤å¤„ä¸ºä¸å‹ç¼©ï¼‰
        0x00, 0x00, 0x00, 0x00, // å›¾åƒæ•°æ®å¤§å°ï¼ˆå ä½ï¼Œç¨åè®¡ç®—ï¼‰
        0x00, 0x00, 0x00, 0x00, // æ°´å¹³åˆ†è¾¨ç‡ï¼ˆåƒç´ /ç±³ï¼Œæ­¤å¤„ä¸º0ï¼Œè¡¨ç¤ºæœªçŸ¥ï¼‰
        0x00, 0x00, 0x00, 0x00, // å‚ç›´åˆ†è¾¨ç‡ï¼ˆåƒç´ /ç±³ï¼Œæ­¤å¤„ä¸º0ï¼Œè¡¨ç¤ºæœªçŸ¥ï¼‰
        0x00, 0x00, 0x00, 0x00, // ä½¿ç”¨çš„é¢œè‰²ç´¢å¼•æ•°ï¼ˆ0è¡¨ç¤ºä½¿ç”¨æ‰€æœ‰è°ƒè‰²æ¿é¡¹ï¼‰
        0x00, 0x00, 0x00, 0x00  // é‡è¦çš„é¢œè‰²ç´¢å¼•æ•°ï¼ˆ0è¡¨ç¤ºæ‰€æœ‰é¢œè‰²éƒ½é‡è¦ï¼‰
    };

    // æ›´æ–°BMPæ–‡ä»¶å¤´éƒ¨ä¿¡æ¯ä¸­çš„å®½åº¦å’Œé«˜åº¦
    *(int*)&bmpHeader[18] = width;
    *(int*)&bmpHeader[22] = height;

    // è®¡ç®—å›¾åƒæ•°æ®å¤§å°
    uint32_t imageDataSize = width * height * 3 + 54; // åŠ ä¸Šæ–‡ä»¶å¤´éƒ¨å¤§å°
    bmpHeader[2] = (uint8_t)(imageDataSize & 0xFF);
    bmpHeader[3] = (uint8_t)((imageDataSize >> 8) & 0xFF);
    bmpHeader[4] = (uint8_t)((imageDataSize >> 16) & 0xFF);
    bmpHeader[5] = (uint8_t)((imageDataSize >> 24) & 0xFF);

    // å†™å…¥BMPæ–‡ä»¶å¤´éƒ¨ä¿¡æ¯
    fwrite(bmpHeader, 1, 54, file);

    // å†™å…¥å›¾åƒæ•°æ®
    fwrite(imageData, width * height * 3, 1, file);

    fclose(file);
}

//24ä½å½©è‰²å›¾åƒè½¬8ä½ç°åº¦å€¼
//rgbImageåŸå§‹å›¾åƒ
//grayImageè¾“å‡ºç°åº¦å›¾åƒ
//width,heightå›¾ç‰‡çš„å®½å’Œé«˜
void convertToGray(uint8_t* rgbImage, uint8_t* grayImage, int width, int height)
{
    for (int y = 0; y < height; y++) {
        for (int x = 0; x < width; x++) {
            // è·å–å½“å‰åƒç´ çš„ RGB åˆ†é‡
            uint8_t r = rgbImage[3 * (y * width + x) + 0];
            uint8_t g = rgbImage[3 * (y * width + x) + 1];
            uint8_t b = rgbImage[3 * (y * width + x) + 2];

            // è®¡ç®—ç°åº¦å€¼ï¼ˆå¸¸ç”¨çš„åŠ æƒå¹³å‡æ³•ï¼‰
            // è¿™é‡Œä½¿ç”¨çš„åŠ æƒç³»æ•°æ˜¯å¸¸è§çš„ï¼šR: 0.299, G: 0.587, B: 0.114
            uint8_t gray = (uint8_t)(0.299 * r + 0.587 * g + 0.114 * b);

            // å°†ç°åº¦å€¼å†™å…¥ç°åº¦å›¾åƒæ•°ç»„
            grayImage[y * width + x] = gray;
        }
    }
}

//ç°åº¦çº¿æ€§æ‹‰ä¼¸
//pGryImgï¼šç°åº¦å›¾åƒæ•°æ®çš„æŒ‡é’ˆã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
//kï¼šçº¿æ€§æ‹‰ä¼¸çš„æ–œç‡ã€‚å®ƒæ§åˆ¶ç€æ‹‰ä¼¸çš„é€Ÿç‡æˆ–ç¨‹åº¦ã€‚å½“(k) å¤§äº 1 æ—¶ï¼Œå›¾åƒçš„å¯¹æ¯”åº¦å¢åŠ ï¼›å½“(k) å°äº 1 æ—¶ï¼Œå¯¹æ¯”åº¦é™ä½ã€‚
//bï¼šçº¿æ€§æ‹‰ä¼¸çš„åç§»ã€‚å®ƒæ§åˆ¶ç€æ‹‰ä¼¸åç°åº¦å€¼çš„èµ·å§‹ä½ç½®ã€‚å½“(b) å¤§äº 0 æ—¶ï¼Œå›¾åƒçš„æ•´ä½“äº®åº¦å¢åŠ ï¼›å½“(b) å°äº 0 æ—¶ï¼Œæ•´ä½“äº®åº¦å‡å°ã€‚
void LinearStretchDemo(uint8_t* pGryImg, int width, int height, double k, double b)
{
    uint8_t* pCur, * pEnd;
    int LUT[256];    //å› ä¸ºåªæœ‰[0,255]å…±256ä¸ªç°åº¦å€¼

    //step1. ç”ŸæˆæŸ¥æ‰¾è¡¨
    for (int g = 0; g < 256; g++)
    {
        LUT[g] = max(0, min(255, k * g + b));
    }

    //step2. è¿›è¡Œå˜æ¢
    for (pCur = pGryImg, pEnd = pGryImg + width * height; pCur < pEnd; pCur++)
    {
        *pCur = LUT[*pCur];
    }
    //step3. ç»“æŸ
    return;
}

//ç»Ÿè®¡å›¾åƒç°åº¦å€¼
//pImgï¼šç°åº¦å›¾åƒæ•°æ®çš„æŒ‡é’ˆã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
//* histogramï¼šæ•°ç»„é¦–å…ƒç´ åœ°å€ï¼Œéœ€è¦ä¸€ä¸ªèƒ½å‚¨å­˜256ä¸ªå˜é‡çš„æ•´å‹æ•°ç»„
void GetHistogram(uint8_t* pImg, int width, int height, int* histogram)
{
    uint8_t* pCur;
    uint8_t* pEnd = pImg + width * height;

    // åˆå§‹åŒ–ç›´æ–¹å›¾æ•°ç»„
    memset(histogram, 0, sizeof(int) * 256);

    // ç›´æ–¹å›¾ç»Ÿè®¡
    for (pCur = pImg; pCur < pEnd;)
    {
        histogram[*pCur]++;
        pCur++;
    }

    // å‡½æ•°ç»“æŸ
    return;
}

//äº®åº¦å’Œå¯¹æ¯”åº¦
//å‚¨å­˜histogramç°åº¦ç›´æ–¹å›¾çš„æŒ‡é’ˆ
//æ¥æ”¶äº®åº¦çš„å˜é‡åœ°å€
//æ¥æ”¶å¯¹æ¯”åº¦çš„å˜é‡åœ°å€
void GetBrightContrast(int* histogram, double* bright, double* contrast)
{
    int g;
    double sum, num; //ä¹¦ä¸Šè¯´å›¾åƒå¾ˆäº®æ—¶ï¼Œintæœ‰å¯èƒ½ä¼šæº¢å‡ºï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œç›´æ¥ç”¨double
    double fsum;

    //step.1 æ±‚äº®åº¦
    for (sum = num = 0, g = 0; g < 256; g++)
    {
        sum += histogram[g] * g;
        num += histogram[g];
    }
    *bright = sum * 1.0 / num;

    //step.2 æ±‚å¯¹æ¯”åº¦
    for (fsum = 0.0, g = 0; g < 256; g++)
    {
        fsum += histogram[g] * (g - *bright) * (g - *bright);
    }
    *contrast = sqrt(fsum / (num - 1)); //å³Std Dev

    //step.3 ç»“æŸ
    return;
}

//pGryImgï¼šç°åº¦å›¾åƒæ•°æ®çš„æŒ‡é’ˆã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
void RmwHistogramEqualize(uint8_t* pGryImg, int width, int height)
{
    uint8_t* pCur, * pEnd = pGryImg + width * height; // æŒ‡é’ˆå˜é‡ï¼ŒæŒ‡å‘å½“å‰åƒç´ å’Œå›¾åƒæœ«å°¾
    int histogram[256], LUT[256], A, g; // ç›´æ–¹å›¾æ•°ç»„ã€æŸ¥æ‰¾è¡¨æ•°ç»„ã€ç´¯ç§¯ç›´æ–¹å›¾ã€ç°åº¦çº§

    // step.1-------------æ±‚ç›´æ–¹å›¾--------------------------//
    memset(histogram, 0, sizeof(int) * 256); // åˆå§‹åŒ–ç›´æ–¹å›¾æ•°ç»„ä¸º0
    for (pCur = pGryImg; pCur < pEnd;)
        histogram[*(pCur++)]++; // ç»Ÿè®¡æ¯ä¸ªç°åº¦çº§å‡ºç°çš„é¢‘ç‡

    // step.2-------------æ±‚LUT[g]-------------------------//
    A = histogram[0]; // åˆå§‹åŒ–ç´¯ç§¯ç›´æ–¹å›¾çš„å€¼ä¸ºç¬¬ä¸€ä¸ªç°åº¦çº§çš„é¢‘ç‡
    LUT[0] = 255 * A / (width * height); // è®¡ç®—ç¬¬ä¸€ä¸ªç°åº¦çº§å¯¹åº”çš„å‡è¡¡åŒ–åçš„ç°åº¦å€¼
    for (g = 1; g < 256; g++) {
        A += histogram[g]; // æ›´æ–°ç´¯ç§¯ç›´æ–¹å›¾çš„å€¼
        LUT[g] = 255 * A / (width * height); // è®¡ç®—å½“å‰ç°åº¦çº§å¯¹åº”çš„å‡è¡¡åŒ–åçš„ç°åº¦å€¼
    }

    // step.3-------------æŸ¥è¡¨------------------------------//
    for (pCur = pGryImg; pCur < pEnd;)
        *(pCur++) = LUT[*pCur]; // ä½¿ç”¨æŸ¥æ‰¾è¡¨å¯¹æ¯ä¸ªåƒç´ è¿›è¡Œç°åº¦æ˜ å°„

    // step.4-------------ç»“æŸ------------------------------//
    return;
}

//å¯¹æ•°å˜æ¢
//pGryImgï¼šç°åº¦å›¾åƒæ•°æ®çš„æŒ‡é’ˆã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
void RmwLogTransform(uint8_t* pGryImg, int width, int height)
{
    uint8_t* pCur, * pEnd = pGryImg + width * height; // æŒ‡å‘ç°åº¦å›¾åƒæ•°æ®çš„å½“å‰æŒ‡é’ˆå’Œç»“æŸæŒ‡é’ˆ
    int histogram[256], LUT[256], gmax, g; // å£°æ˜ç›´æ–¹å›¾æ•°ç»„ã€æŸ¥æ‰¾è¡¨æ•°ç»„ã€æœ€å¤§ç°åº¦å€¼ã€å½“å‰ç°åº¦å€¼
    double c; // å£°æ˜å¸¸æ•°c

    // step.1-------------æ±‚ç›´æ–¹å›¾--------------------------//
    memset(histogram, 0, sizeof(int) * 256); // åˆå§‹åŒ–ç›´æ–¹å›¾æ•°ç»„ä¸º0
    for (pCur = pGryImg; pCur < pEnd;)
        histogram[*(pCur++)]++; // éå†å›¾åƒæ•°æ®ï¼Œç»Ÿè®¡æ¯ä¸ªç°åº¦çº§çš„åƒç´ æ•°é‡

    // step.2-------------æœ€å¤§å€¼---------------------------//
    for (gmax = 255; gmax >= 0; gmax++)
        if (histogram[gmax]) break; // ä»æœ€å¤§ç°åº¦çº§å¼€å§‹å‘ä½ç°åº¦çº§æœç´¢ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªéé›¶ç°åº¦çº§ï¼Œå³æœ€å¤§ç°åº¦å€¼

    // step.3-------------æ±‚LUT[g]-------------------------//
    c = 255.0 / log(1 + gmax); // è®¡ç®—å¸¸æ•°c
    for (g = 0; g < 256; g++)
    {
        LUT[g] = (int)(c * log(1 + g)); // æ ¹æ®å¯¹æ•°å˜æ¢å…¬å¼è®¡ç®—æŸ¥æ‰¾è¡¨ä¸­æ¯ä¸ªç°åº¦çº§çš„æ˜ å°„å€¼
    }

    // step.4-------------æŸ¥è¡¨------------------------------//
    for (pCur = pGryImg; pCur < pEnd;)
        *(pCur++) = LUT[*pCur]; // ä½¿ç”¨æŸ¥æ‰¾è¡¨å°†å›¾åƒæ•°æ®è¿›è¡Œå¯¹æ•°å˜æ¢

    // step.5-------------ç»“æŸ------------------------------//
    return; // å‡½æ•°ç»“æŸ
}

//åŸºäºåˆ—ç§¯åˆ†çš„å¿«é€Ÿå‡å€¼æ»¤æ³¢
//åŸå§‹ç°åº¦å›¾åƒ
//å›¾åƒçš„å®½åº¦å’Œé«˜åº¦
//æ»¤æ³¢é‚»åŸŸï¼šMåˆ—Nè¡Œ
//ç»“æœå›¾åƒ
void RmwAvrFilterBySumCol(uint8_t* pGryImg,int width, int height,int M, int N,uint8_t* pResImg) 
{
    uint8_t* pAdd, * pDel, * pRes;
    int halfx, halfy;
    int x, y;
    int sum, c;
    int sumCol[4096]; // çº¦å®šå›¾åƒå®½åº¦ä¸å¤§äº4096

    // step.1------------åˆå§‹åŒ–--------------------------//
    M = M / 2 * 2 + 1; // å¥‡æ•°åŒ–
    N = N / 2 * 2 + 1; // å¥‡æ•°åŒ–
    halfx = M / 2; // æ»¤æ³¢å™¨çš„åŠå¾„x
    halfy = N / 2; // æ»¤æ³¢å™¨çš„åŠå¾„y
    c = (1 << 23) / (M * N); // ä¹˜æ³•å› å­
    memset(sumCol, 0, sizeof(int) * width);
    for (y = 0, pAdd = pGryImg; y < N; y++) {
        for (x = 0; x < width; x++) sumCol[x] += *(pAdd++);
    }
    // step.2------------æ»¤æ³¢----------------------------//
    for (y = halfy, pRes = pResImg + y * width, pDel = pGryImg; y < height - halfy; y++) {
        // åˆå€¼
        for (sum = 0, x = 0; x < M; x++) sum += sumCol[x];
        // æ»¤æ³¢
        pRes += halfx; // è·³è¿‡å·¦ä¾§
        for (x = halfx; x < width - halfx; x++) {
            // æ±‚ç°åº¦å‡å€¼
            // *(pRes++)=sum/(N*M);
            *(pRes++) = (sum * c) >> 23; // ç”¨æ•´æ•°ä¹˜æ³•å’Œç§»ä½ä»£æ›¿é™¤æ³•
            // æ¢åˆ—,æ›´æ–°ç°åº¦å’Œ
            sum -= sumCol[x - halfx]; // å‡å·¦è¾¹åˆ—
            sum += sumCol[x + halfx + 1]; // åŠ å³è¾¹åˆ—
        }
        pRes += halfx; // è·³è¿‡å³ä¾§
        // æ¢è¡Œ,æ›´æ–°sumCol
        for (x = 0; x < width; x++) {
            sumCol[x] -= *(pDel++); // å‡ä¸Šä¸€è¡Œ
            sumCol[x] += *(pAdd++); // åŠ ä¸‹ä¸€è¡Œ
        }
    }
    // step.3------------è¿”å›----------------------------//
    return;
}

//åŸºäºåˆ—ç§¯åˆ†çš„ç§¯åˆ†å›¾å®ç°
//pGryImg, // åŸå§‹ç°åº¦å›¾åƒ
//width,       // å›¾åƒçš„å®½åº¦ 
//height,      // å›¾åƒçš„é«˜åº¦
//pSumImg     // è®¡ç®—å¾—åˆ°çš„ç§¯åˆ†å›¾
void RmwDoSumGryImg(uint8_t* pGryImg,int width,int height, int* pSumImg)
{
    uint8_t* pGry;
    int* pRes;
    int x, y;
    int sumCol[4096]; // çº¦å®šå›¾åƒå®½åº¦ä¸å¤§äº4096

    memset(sumCol, 0, sizeof(int) * width);
    for (y = 0, pGry = pGryImg, pRes = pSumImg; y < height; y++)
    {
        // æœ€å·¦ä¾§åƒç´ çš„ç‰¹åˆ«å¤„ç†
        sumCol[0] += *(pGry++);
        *(pRes++) = sumCol[0];
        // æ­£å¸¸å¤„ç†
        for (x = 1; x < width; x++)
        {
            sumCol[x] += *(pGry++);       // æ›´æ–°åˆ—ç§¯åˆ†
            int temp = *(pRes - 1);
            *(pRes++) = temp + sumCol[x];
        }
    }
    return;
}

//åŸºäºSSEçš„ç§¯åˆ†å›¾å®ç°
//pGryImgåŸå§‹ç°åº¦å›¾åƒ
//widthå›¾åƒçš„å®½åº¦ï¼Œå¿…é¡»æ˜¯4çš„å€æ•°
//heightå›¾åƒçš„é«˜åº¦
//pSumImgè®¡ç®—å¾—åˆ°çš„ç§¯åˆ†å›¾
void RmwDoSumGryImg_SSE(uint8_t* pGryImg,int width,int height,int* pSumImg)
{
    int sumCol[4096]; //çº¦å®šå›¾åƒå®½åº¦ä¸å¤§äº4096
    __m128i* pSumSSE, A;
    uint8_t* pGry;
    int* pRes;
    int x, y;

    memset(sumCol, 0, sizeof(int) * width);
    for (y = 0, pGry = pGryImg, pRes = pSumImg; y < height; y++)
    {
        // 0:éœ€è¦ç‰¹åˆ«å¤„ç†
        sumCol[0] += *(pGry++);
        *(pRes++) = sumCol[0];
        // 1
        sumCol[1] += *(pGry++);
        *(pRes++) = *(pRes - 1) + sumCol[1];
        // 2
        sumCol[2] += *(pGry++);
        *(pRes++) = *(pRes - 1) + sumCol[2];
        // 3
        sumCol[3] += *(pGry++);
        *(pRes++) = *(pRes - 1) + sumCol[3];
        // [4...width-1]
        for (x = 4, pSumSSE = (__m128i*)(sumCol + 4); x < width; x += 4, pGry += 4)
        {
            // æŠŠå˜é‡çš„ä½32ä½(æœ‰4ä¸ª8ä½æ•´æ•°ç»„æˆ)è½¬æ¢æˆ32ä½çš„æ•´æ•°
            A = _mm_cvtepu8_epi32(_mm_loadl_epi64((__m128i*)pGry));
            // 4ä¸ª32ä½çš„æ•´æ•°ç›¸åŠ 
            *(pSumSSE++) = _mm_add_epi32(*pSumSSE, A);
            // é€’æ¨
            *(pRes++) = *(pRes - 1) + sumCol[x + 0];
            *(pRes++) = *(pRes - 1) + sumCol[x + 1];
            *(pRes++) = *(pRes - 1) + sumCol[x + 2];
            *(pRes++) = *(pRes - 1) + sumCol[x + 3];
        }
    }
    return;
}

//åŸºäºç§¯åˆ†å›¾çš„å¿«é€Ÿå‡å€¼æ»¤æ³¢
//pSumImgè®¡ç®—å¾—åˆ°çš„ç§¯åˆ†å›¾
//width,height,å›¾åƒçš„å®½åº¦å’Œé«˜åº¦
//M, N,æ»¤æ³¢é‚»åŸŸï¼šMåˆ—Nè¡Œ
//pResImg ç»“æœå›¾åƒ
void RmwAvrFilterBySumImg(int* pSumImg,int width, int height,int M, int N,uint8_t* pResImg)
{
    // æ²¡æœ‰å¯¹è¾¹ç•Œä¸Šé‚»åŸŸä¸å®Œæ•´çš„åƒç´ è¿›è¡Œå¤„ç†ï¼Œå¯ä»¥é‡‡ç”¨å˜çª—å£çš„ç­–ç•¥
    int* pY1, * pY2;
    uint8_t* pRes;
    int halfx, halfy;
    int y, x1, x2;
    int sum, c;

    // step.1------------åˆå§‹åŒ–--------------------------//
    M = M / 2 * 2 + 1; // å¥‡æ•°åŒ–
    N = N / 2 * 2 + 1; // å¥‡æ•°åŒ–
    halfx = M / 2;      // æ»¤æ³¢å™¨çš„åŠå¾„x
    halfy = N / 2;      // æ»¤æ³¢å™¨çš„åŠå¾„y
    c = (1 << 23) / (M * N); // ä¹˜æ³•å› å­
    // step.2------------æ»¤æ³¢----------------------------//
    for (y = halfy + 1, pRes = pResImg + y * width, pY1 = pSumImg, pY2 = pSumImg + N * width;
        y < height - halfy;
        y++, pY1 += width, pY2 += width)
    {
        pRes += halfx + 1; // è·³è¿‡å·¦ä¾§
        for (x1 = 0, x2 = M; x2 < width; x1++, x2++) // å¯ä»¥ç®€åŒ–å¦‚æ­¤ï¼Œä½†ä¸å¤ªå®¹æ˜“è¯»
        {
            sum = *(pY2 + x2) - *(pY2 + x1) - *(pY1 + x2) + *(pY1 + x1);
            *(pRes++) = (uint8_t)((sum * c) >> 23); // ç”¨æ•´æ•°ä¹˜æ³•å’Œç§»ä½ä»£æ›¿é™¤æ³•
        }
        pRes += halfx; // è·³è¿‡å³ä¾§
    }
    // step.3------------è¿”å›----------------------------//
    return;
}

void GetMedianGry(int* histogram, int N, int* medGry)
{
    int g;
    int num;

    // step.1-------------æ±‚ç°åº¦ä¸­å€¼------------------------//
    num = 0;
    for (g = 0; g < 256; g++)
    {
        num += histogram[g];
        if (2 * num > N) break;  //num>N/2
    }
    *medGry = g;
    // step.2-------------ç»“æŸ------------------------------//
    return;
}

//ä¸­å€¼æ»¤æ³¢
//pGryImgï¼šæŒ‡å‘å¾…å¤„ç†ç°åº¦å›¾åƒæ•°æ®çš„æŒ‡é’ˆã€‚
//widthã€heightï¼šè¡¨ç¤ºå›¾åƒçš„å®½åº¦å’Œé«˜åº¦ã€‚
//Mã€Nï¼šåˆ†åˆ«è¡¨ç¤ºä¸­å€¼æ»¤æ³¢å™¨çš„æ°´å¹³å’Œå‚ç›´é‚»åŸŸå¤§å°ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰ã€‚
//pResImgï¼šæŒ‡å‘å­˜å‚¨ç»“æœå›¾åƒæ•°æ®çš„æŒ‡é’ˆã€‚
double RmwMedianFilter(uint8_t* pGryImg, int width, int height, int M, int N, uint8_t* pResImg) 
{
    uint8_t* pCur, * pRes;
    int halfx, halfy, x, y, i, j, y1, y2;
    int histogram[256];
    int wSize, j1, j2;
    int num, med, v;
    int dbgCmpTimes = 0; // æœç´¢ä¸­å€¼æ‰€éœ€æ¯”è¾ƒæ¬¡æ•°çš„è°ƒè¯•

    M = M / 2 * 2 + 1; // å¥‡æ•°åŒ–
    N = N / 2 * 2 + 1; // å¥‡æ•°åŒ–
    halfx = M / 2;      // xåŠå¾„
    halfy = N / 2;      // yåŠå¾„
    wSize = (halfx * 2 + 1) * (halfy * 2 + 1); // é‚»åŸŸå†…åƒç´ æ€»ä¸ªæ•°

    for (y = halfy, pRes = pResImg + y * width; y < height - halfy; y++) {
        // step.1----åˆå§‹åŒ–ç›´æ–¹å›¾
        y1 = y - halfy;
        y2 = y + halfy;
        memset(histogram, 0, sizeof(int) * 256);

        for (i = y1, pCur = pGryImg + i * width; i <= y2; i++, pCur += width) {
            for (j = 0; j < halfx * 2 + 1; j++) {
                histogram[*(pCur + j)]++;
            }
        }

        // step.2-----åˆå§‹åŒ–ä¸­å€¼
        num = 0; // è®°å½•ç€ç°åº¦å€¼ä»0åˆ°ä¸­å€¼çš„ä¸ªæ•°
        for (i = 0; i < 256; i++) {
            num += histogram[i];
            if (num * 2 > wSize) {
                med = i;
                break;
            }
        }

        // æ»¤æ³¢
        pRes += halfx; // æ²¡æœ‰å¤„ç†å›¾åƒå·¦è¾¹ç•Œä¾§çš„åƒç´ 
        for (x = halfx; x < width - halfx; x++) {
            // èµ‹å€¼
            *(pRes++) = med;

            // step.3-----ç›´æ–¹å›¾é€’æ¨: å‡å»å½“å‰é‚»åŸŸæœ€å·¦è¾¹çš„ä¸€åˆ—,æ·»åŠ é‚»åŸŸå³ä¾§çš„ä¸€ä¸ªæ–°åˆ—
            j1 = x - halfx;     // æœ€å·¦è¾¹åˆ—
            j2 = x + halfx + 1; // å³è¾¹çš„æ–°åˆ—

            for (i = y1, pCur = pGryImg + i * width; i <= y2; i++, pCur += width) {
                // å‡å»æœ€å·¦è¾¹åˆ—
                v = *(pCur + j1);
                histogram[v]--;  // æ›´æ–°ç›´æ–¹å›¾
                if (v <= med) num--; // æ›´æ–°num

                // æ·»åŠ å³è¾¹çš„æ–°åˆ—
                v = *(pCur + j2);
                histogram[v]++; // æ›´æ–°ç›´æ–¹å›¾
                if (v <= med) num++; // æ›´æ–°num
            }

            // step.4-----æ›´æ–°ä¸­å€¼
            if (num * 2 < wSize) { // åˆ°ä¸Šæ¬¡ä¸­å€¼medçš„ä¸ªæ•°ä¸å¤Ÿäº†,åˆ™medè¦å˜å¤§
                for (med = med + 1; med < 256; med++) {
                    dbgCmpTimes += 2; // æ€»çš„æ¯”è¾ƒæ¬¡æ•°,è°ƒè¯•ç”¨
                    num += histogram[med];
                    if (num * 2 > wSize) break;
                }
                dbgCmpTimes += 1; // æ€»çš„æ¯”è¾ƒæ¬¡æ•°,è°ƒè¯•ç”¨
            }
            else { // åˆ°ä¸Šæ¬¡ä¸­å€¼medçš„ä¸ªæ•°å¤šäº†,åˆ™medè¦å˜å°
                while ((num - histogram[med]) * 2 > wSize) { // è‹¥å‡å»å,ä»å˜å°
                    dbgCmpTimes++; // æ€»çš„æ¯”è¾ƒæ¬¡æ•°,è°ƒè¯•ç”¨
                    num -= histogram[med];
                    med--;
                }
                dbgCmpTimes += 2; // æ€»çš„æ¯”è¾ƒæ¬¡æ•°,è°ƒè¯•ç”¨
            }
        }
        pRes += halfx; // æ²¡æœ‰å¤„ç†å›¾åƒå³è¾¹ç•Œä¾§çš„åƒç´ 
    }
    // è¿”å›æœç´¢ä¸­å€¼éœ€è¦çš„å¹³å‡æ¯”è¾ƒæ¬¡æ•°
    return dbgCmpTimes * 1.0 / ((width - halfx * 2) * (height - halfy * 2));
}

//äºŒå€¼æ»¤æ³¢
//pBinImg,  åŸå§‹äºŒå€¼å›¾åƒ
// width, height,å›¾åƒçš„å®½åº¦å’Œé«˜åº¦
// M, N, æ»¤æ³¢é‚»åŸŸï¼šMåˆ—Nè¡Œ
// threshold, ç°åº¦é˜ˆå€¼,å¤§äºç­‰äºè¯¥å€¼æ—¶ç»“æœèµ‹255
// pResImg ç»“æœå›¾åƒ
void RmwBinImgFilter(uint8_t* pBinImg,int width, int height,int M, int N,double threshold,uint8_t* pResImg )
{
    // æ²¡æœ‰å¯¹è¾¹ç•Œä¸Šé‚»åŸŸä¸å®Œæ•´çš„åƒç´ è¿›è¡Œå¤„ç†ï¼Œå¯ä»¥é‡‡ç”¨å˜çª—å£çš„ç­–ç•¥
    uint8_t* pAdd, * pDel, * pRes;
    int halfx, halfy;
    int x, y, sum, sumThreshold;
    int sumCol[4096]; //çº¦å®šå›¾åƒå®½åº¦ä¸å¤§äº4096

    // step.1------------åˆå§‹åŒ–--------------------------//
    M = M / 2 * 2 + 1; //å¥‡æ•°åŒ–
    N = N / 2 * 2 + 1; //å¥‡æ•°åŒ–
    halfx = M / 2; //æ»¤æ³¢å™¨çš„xåŠå¾„
    halfy = N / 2; //æ»¤æ³¢å™¨çš„yåŠå¾„
    sumThreshold = max(1, (int)(threshold * M * N)); //è½¬æ¢æˆé‚»åŸŸå†…ç°åº¦å€¼ä¹‹å’Œçš„é˜ˆå€¼
    memset(sumCol, 0, sizeof(int) * width);
    for (y = 0, pAdd = pBinImg; y < N; y++)
    {
        for (x = 0; x < width; x++)
            sumCol[x] += *(pAdd++);
    }
    // step.2------------æ»¤æ³¢----------------------------//
    for (y = halfy, pRes = pResImg + y * width, pDel = pBinImg; y < height - halfy; y++)
    {
        //åˆå€¼
        for (sum = 0, x = 0; x < M; x++)
            sum += sumCol[x];
        //æ»¤æ³¢
        pRes += halfx; //è·³è¿‡å·¦ä¾§
        for (x = halfx; x < width - halfx; x++)
        {
            //æ±‚ç°åº¦å‡å€¼
            /*if (sum>=sumThreshold)
            {
                *(pRes++) = 255;
            }
            else  *(pRes++) = 0;*/
            *(pRes++) = (sum >= sumThreshold) * 255; //è¯·ç†è§£è¿™ä¸ªè¡¨è¾¾å¼çš„å«ä¹‰
            //æ¢åˆ—,æ›´æ–°ç°åº¦å’Œ
            sum -= sumCol[x - halfx];     //å‡å·¦è¾¹åˆ—
            sum += sumCol[x + halfx + 1]; //åŠ å³è¾¹åˆ—
        }
        pRes += halfx; //è·³è¿‡å³ä¾§
        //æ¢è¡Œ,æ›´æ–°sumCol
        for (x = 0; x < width; x++)
        {
            sumCol[x] -= *(pDel++); //å‡ä¸Šä¸€è¡Œ
            sumCol[x] += *(pAdd++); //åŠ ä¸‹ä¸€è¡Œ
        }
    }
    // step.3------------è¿”å›----------------------------//
    return;
}

//æ¢¯åº¦ç®—å­åŠ é˜ˆå€¼
//pGryImgï¼šè¾“å…¥çš„ç°åº¦å›¾åƒæ•°æ®æŒ‡é’ˆã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
//pGrdImgï¼šè¾“å‡ºçš„æ¢¯åº¦å›¾åƒæ•°æ®æŒ‡é’ˆ
void RmwGradientGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pGrdImg)
{
    uint8_t* pGry, * pGrd;
    int dx, dy;
    int x, y;

    for (y = 0, pGry = pGryImg, pGrd = pGrdImg; y < height - 1; y++)
    {
        for (x = 0; x < width - 1; x++, pGry++)
        {
            dx = *pGry - *(pGry + 1);
            dy = *pGry - *(pGry + width);
            int gradient = (int)(sqrt(dx * dx * 1.0 + dy * dy));
            *pGrd++ = (gradient > 255) ? 255 : gradient;
        }
        *pGrd++ = 0; //å°¾åˆ—ä¸åš,è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pGrd, 0, width); //å°¾è¡Œä¸åš,è¾¹ç¼˜å¼ºåº¦èµ‹0
}

//æ¢¯åº¦ç®—å­åŠ é˜ˆå€¼
//pGryImgï¼šè¾“å…¥çš„ç°åº¦å›¾åƒæ•°æ®æŒ‡é’ˆã€‚
//widthï¼šå›¾åƒçš„å®½åº¦ã€‚
//heightï¼šå›¾åƒçš„é«˜åº¦ã€‚
//pGrdImgï¼šè¾“å‡ºçš„æ¢¯åº¦å›¾åƒæ•°æ®æŒ‡é’ˆ
void RmwGradientGryImgPlus(uint8_t* pGryImg, int width, int height, uint8_t* pGrdImg, int threshold)
{
    uint8_t* pGry, * pGrd;
    int dx, dy;
    int x, y;

    for (y = 0, pGry = pGryImg, pGrd = pGrdImg; y < height - 1; y++)
    {
        for (x = 0; x < width - 1; x++, pGry++)
        {
            dx = *pGry - *(pGry + 1);
            dy = *pGry - *(pGry + width);
            int gradient = (int)(sqrt(dx * dx * 1.0 + dy * dy));
            *(pGrd++) = (gradient > threshold) ? min(255, gradient) : 0;
        }
        *(pGrd++) = 0; //å°¾åˆ—ä¸åš,è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pGrd, 0, width); //å°¾è¡Œä¸åš,è¾¹ç¼˜å¼ºåº¦èµ‹0
}

//åç›¸
void invertImage(uint8_t* image, int width, int height) {
    for (int i = 0; i < width * height; i++) {
        image[i] = 255 - image[i];
    }
}

//ç½—ä¼¯ç‰¹ç®—å­
void RmwRobertsGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pRbtImg)
{
    uint8_t* pGry, * pRbt;
    int dx, dy;
    int x, y;

    for (y = 0, pGry = pGryImg, pRbt = pRbtImg; y < height - 1; y++)
    {
        for (x = 0; x < width - 1; x++, pGry++)
        {
            dx = *pGry - *(pGry + width + 1);
            dy = *(pGry + 1) - *(pGry + width);
            *pRbt++ = (uint8_t)(dx > dy ? dx : dy); // ä½¿ç”¨ä¸‰ç›®è¿ç®—ç¬¦é€‰æ‹©è¾ƒå¤§çš„å€¼
        }
        *pRbt++ = 0; // å°¾åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pRbt, 0, width); // å°¾è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
}

//ç´¢è´å°”ç®—å­
void RmwSobelGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pSbImg)
{
    uint8_t* pGry, * pSb;
    int dx, dy;
    int x, y;

    memset(pSbImg, 0, width); // é¦–è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
    for (y = 1, pGry = pGryImg + width, pSb = pSbImg + width; y < height - 1; y++)
    {
        *pSb++ = 0; // é¦–åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
        for (x = 1; x < width - 1; x++, pGry++)
        {
            // æ±‚dx
            dx = *(pGry - 1 - width) + (*(pGry - 1) * 2) + *(pGry - 1 + width);
            dx -= *(pGry + 1 - width) + (*(pGry + 1) * 2) + *(pGry + 1 + width);
            // æ±‚dy
            dy = *(pGry - width - 1) + (*(pGry - width) * 2) + *(pGry - width + 1);
            dy -= *(pGry + width - 1) + (*(pGry + width) * 2) + *(pGry + width + 1);
            // ç»“æœ
            *pSb++ = (uint8_t)min(255, abs(dx) + abs(dy));
        }
        *pSb++ = 0; // å°¾åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pSb, 0, width); // å°¾è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
}

//Prewittç®—å­
void RmwPrewittGryImg(uint8_t* pGryImg, int width, int height, uint8_t* pPRTImg)
{
    uint8_t* pGry, * pPRT;
    int dx, dy, d45, d135, v1, v2;
    int x, y;

    memset(pPRTImg, 0, width); // é¦–è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
    for (y = 1, pGry = pGryImg + width, pPRT = pPRTImg + width; y < height - 1; y++)
    {
        *pPRT++ = 0; // é¦–åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
        for (x = 1; x < width - 1; x++, pGry++)
        {
            // æ±‚dx
            dx = *(pGry - 1 - width) + *(pGry - 1) + *(pGry - 1 + width);
            dx -= *(pGry + 1 - width) + *(pGry + 1) + *(pGry + 1 + width);
            // æ±‚dy
            dy = *(pGry - width - 1) + *(pGry - width) + *(pGry - width + 1);
            dy -= *(pGry + width - 1) + *(pGry + width) + *(pGry + width + 1);
            // æ±‚45åº¦
            d45 = *(pGry - width - 1) + *(pGry - width) + *(pGry - 1);
            d45 -= *(pGry + width + 1) + *(pGry + width) + *(pGry + 1);
            // æ±‚135åº¦
            d135 = *(pGry - width) + *(pGry - width + 1) + *(pGry + 1);
            d135 -= *(pGry + width - 1) + *(pGry + width) + *(pGry - 1);
            // ç»“æœ
            v1 = abs(dx) > abs(dy) ? abs(dx) : abs(dy);
            v2 = abs(d45) > abs(d135) ? abs(d45) : abs(d135);
            *pPRT++ = (uint8_t)((v1 > v2) ? ((v1 > 255) ? 255 : v1) : ((v2 > 255) ? 255 : v2));
        }
        *pPRT++ = 0; // å°¾åˆ—ä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
        pGry++;
    }
    memset(pPRT, 0, width); // å°¾è¡Œä¸åš, è¾¹ç¼˜å¼ºåº¦èµ‹0
}

//æ²ˆä¿Šç®—å­
//pGryImg å’Œ pTmpImg æ˜¯æŒ‡å‘ uint8_t ç±»å‹çš„æŒ‡é’ˆï¼Œå®ƒä»¬åˆ†åˆ«æŒ‡å‘åŸå§‹ç°åº¦å›¾åƒæ•°æ®å’Œè¾…åŠ©å›¾åƒæ•°æ®ã€‚
//width å’Œ height æ˜¯æ•´å‹å‚æ•°ï¼Œè¡¨ç¤ºå›¾åƒçš„å®½åº¦å’Œé«˜åº¦ã€‚
//a0 æ˜¯åŒç²¾åº¦æµ®ç‚¹å‹å‚æ•°ï¼Œè¡¨ç¤ºæ»¤æ³¢ç³»æ•°ã€‚
//pSJImg æ˜¯æŒ‡å‘ uint8_t ç±»å‹çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘äº†è¾“å‡ºçš„å›¾åƒæ•°æ®ã€‚
void RmwShenJunGryImg(uint8_t* pGryImg,uint8_t* pTmpImg, int width, int height, double a0, uint8_t* pSJImg)
{
    uint8_t* pGry, * pCur, * pSJ, * pEnd;
    int LUT[512], * ALUT; // a0æŸ¥æ‰¾è¡¨
    int x, y, pre, dif;

    // Step 1: åˆå§‹åŒ–æŸ¥æ‰¾è¡¨
    a0 = (a0 < 0.01) ? 0.01 : ((a0 > 0.99) ? 0.99 : a0); // å®‰å…¨æ€§æ£€æŸ¥
    // a0æŸ¥æ‰¾è¡¨, è¿›è¡Œäº†å››èˆäº”å…¥
    ALUT = LUT + 256;
    for (ALUT[0] = 0, dif = 1; dif < 256; dif++)
    {
        ALUT[dif] = (int)(dif * a0 + 0.5);
        ALUT[-dif] = (int)(-dif * a0 - 0.5);
    }

    // Step 2: é€’æ¨å®ç°æŒ‡æ•°æ»¤æ³¢
    // æŒ‰è¡Œæ»¤æ³¢
    for (y = 0, pGry = pGryImg, pCur = pTmpImg; y < height; y++)
    {
        // ä»å·¦å‘å³: p1(y,x) = p1(y,x-1) + a * [p(y,x) - p1(y,x-1)]
        *(pCur++) = pre = *(pGry++);
        for (x = 1; x < width; x++, pGry++)
            *(pCur++) = pre = pre + ALUT[*pGry - pre];
        pCur--; // å›åˆ°è¡Œå°¾
        // ä»å³å‘å·¦: p2(y,x) = p2(y,x+1) - a * [p1(y,x) - p2(y,x+1)]
        for (x = width - 2, pCur = pCur - 1; x >= 0; x--)
            *(pCur--) = pre = pre + ALUT[*pCur - pre];
        pCur += (width + 1); // å›åˆ°ä¸‹ä¸€è¡Œçš„å¼€å§‹
    }
    // æŒ‰åˆ—æ»¤æ³¢
    for (x = 0, pCur = pTmpImg; x < width; x++, pCur = pTmpImg + x)
    {
        // ä»ä¸Šå‘ä¸‹: p3(y,x) = p3(y-1,x) + a * [p2(y,x) - p3(y-1,x)]
        pre = *pCur;
        for (y = 1, pCur += width; y < height; y++, pCur += width)
            *pCur = pre = pre + ALUT[*pCur - pre];
        pCur -= width; // å›åˆ°åˆ—å°¾
        // ä»ä¸‹å‘ä¸Š: p4(i,j) = p4(i+1,j) + a * [p3(i,j) - p4(i+1,j)]
        for (y = height - 2, pCur -= width; y >= 0; y--, pCur -= width)
            *pCur = pre = pre + ALUT[*pCur - pre];
    }

    // Step 3: æ­£å¯¼æ•°=1ï¼Œè´Ÿå¯¼æ•°ä¸º0ï¼Œ0å¿…é¡»ä¹Ÿæ˜¯0
    pEnd = pTmpImg + width * height;
    for (pCur = pTmpImg, pGry = pGryImg; pCur < pEnd; pGry++)
    {
        *(pCur++) = (*pCur > *pGry);
    }

    // Step 4: è¿‡é›¶ç‚¹æ£€æµ‹
    memset(pSJImg, 0, width * height); // è¾¹ç¼˜å¼ºåº¦èµ‹0
    pSJ = pSJImg + width;
    pCur = pTmpImg + width; // é¦–è¡Œä¸åš 
    for (y = 1; y < height - 1; y++)
    {
        pSJ++; pCur++;  // é¦–åˆ—ä¸åš
        for (x = 1; x < width - 1; x++, pGry++, pCur++, pSJ++)
        {
            if (*pCur) // æ­£å¯¼æ•°
            {
                // ä¸‹é¢ä½¿ç”¨4é‚»åŸŸ, è¾¹ç¼˜ä¸º8è¿é€š, ä¸èƒ½ä¿è¯4è¿é€š; ä½¿ç”¨8é‚»åŸŸæ‰èƒ½ä¿è¯è¾¹ç¼˜4è¿é€š
                if ((!*(pCur - 1)) || // å·¦, å¿…é¡»<=0, ä¸èƒ½<0
                    (!*(pCur + 1)) || // å³, å¿…é¡»<=0, ä¸èƒ½<0
                    (!*(pCur - width)) || // ä¸Š, å¿…é¡»<=0, ä¸èƒ½<0
                    (!*(pCur + width)))   // ä¸‹, å¿…é¡»<=0, ä¸èƒ½<0
                {
                    *pSJ = 255; // å‘¨å›´æœ‰å¯¼æ•°å°äºç­‰äº0
                }
            }
        }
        pSJ++; pCur++;  // å°¾åˆ—ä¸åš
    }
}

//æ²ˆä¿Šç®—å­åŠ ç´¢è´å°”ç®—å­
//pGryImgï¼šæŒ‡å‘åŸå§‹ç°åº¦å›¾åƒæ•°æ®çš„æŒ‡é’ˆ
//pTmpImgï¼šæŒ‡å‘è¾…åŠ©å›¾åƒæ•°æ®çš„æŒ‡é’ˆ
//widthï¼šå›¾åƒçš„å®½åº¦
//heightï¼šå›¾åƒçš„é«˜åº¦
//a0ï¼šè¿™æ˜¯æ²ˆä¿Šç®—å­çš„å‚æ•°ï¼Œç”¨äºæ§åˆ¶è¾¹ç¼˜æ£€æµ‹çš„çµæ•åº¦ã€‚
//grdThreï¼šè¿™æ˜¯Sobelç®—å­çš„æ¢¯åº¦é˜ˆå€¼
//pEdgeImgï¼šæœ€ç»ˆè¾¹ç¼˜å›¾åƒæ•°æ®çš„æŒ‡é’ˆ
void RmwExtractRiceEdge(uint8_t* pGryImg,uint8_t* pTmpImg,int width,int height,double a0, int grdThre, uint8_t* pEdgeImg)
{
    // step.1------------æ²ˆä¿Šç®—å­-----------------------//
    RmwShenJunGryImg(pGryImg, pTmpImg, width, height, a0, pEdgeImg);
    // step.2------------Sobelç®—å­----------------------//
    RmwSobelGryImg(pGryImg, width, height, pTmpImg);
    // step.3------------äºŒè€…èåˆ-----------------------//
    for (int i = 0; i < width * height; i++)
    {
        *(pEdgeImg + i) = (pEdgeImg[i] && (pTmpImg[i] > grdThre)) * 255;
    }
    // step.4------------ç»“æŸ---------------------------//
    return;
}
```



